name: Watchdog - Auto Recovery

on:
  schedule:
    # ðŸ”§ å„ªåŒ–ï¼šå¾žæ¯ 10 åˆ†é˜æ”¹ç‚ºæ¯ 30 åˆ†é˜ï¼ˆæ¸›å°‘ egressï¼‰
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  watchdog:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check last process workflow run
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç²å–æœ€å¾Œä¸€æ¬¡ process workflow çš„åŸ·è¡Œæ™‚é–“
          LAST_RUN=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow "Process Article Jobs" \
            --limit 1 \
            --json createdAt \
            --jq '.[0].createdAt')

          if [ -z "$LAST_RUN" ]; then
            echo "needs_trigger=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ No recent runs found"
            exit 0
          fi

          # è¨ˆç®—è·é›¢ä¸Šæ¬¡åŸ·è¡Œçš„åˆ†é˜æ•¸
          LAST_RUN_EPOCH=$(date -d "$LAST_RUN" +%s)
          NOW_EPOCH=$(date +%s)
          DIFF_MINUTES=$(( (NOW_EPOCH - LAST_RUN_EPOCH) / 60 ))

          echo "Last run: $LAST_RUN ($DIFF_MINUTES minutes ago)"

          # å¦‚æžœè¶…éŽ 30 åˆ†é˜æ²’åŸ·è¡Œï¼Œè§¸ç™¼æ¢å¾©ï¼ˆé…åˆæ–°çš„æª¢æŸ¥é »çŽ‡ï¼‰
          if [ $DIFF_MINUTES -gt 30 ]; then
            echo "needs_trigger=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Process workflow hasn't run in $DIFF_MINUTES minutes - will trigger recovery"
          else
            echo "needs_trigger=false" >> $GITHUB_OUTPUT
            echo "âœ… Process workflow is running normally"
          fi

      - name: Trigger process workflow if needed
        if: steps.check.outputs.needs_trigger == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Triggering Process Article Jobs workflow..."
          gh workflow run "Process Article Jobs" --repo ${{ github.repository }}
          echo "âœ… Recovery triggered successfully"
