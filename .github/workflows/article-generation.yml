name: Article Generation Worker
run-name: è™•ç†æ–‡ç« ç”Ÿæˆä»»å‹™ - ${{ github.event.client_payload.title || 'æ‰¹æ¬¡è™•ç†' }}

on:
  # æ‰‹å‹•è§¸ç™¼ï¼ˆå¾ Vercel API è§¸ç™¼ï¼‰
  repository_dispatch:
    types: [generate-article]

  # å®šæ™‚åŸ·è¡Œï¼ˆæ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡å¾…è™•ç†ä»»å‹™ï¼‰
  schedule:
    - cron: '*/5 * * * *'

  # æ‰‹å‹•åŸ·è¡Œï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
  workflow_dispatch:
    inputs:
      jobId:
        description: 'Article Job ID (optional)'
        required: false
        type: string

jobs:
  generate-article:
    name: ç”Ÿæˆæ–‡ç« 
    runs-on: ubuntu-latest
    timeout-minutes: 30  # æœ€å¤š 30 åˆ†é˜ï¼Œè¶³å¤ è™•ç†è¤‡é›œæ–‡ç« 

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ç²å– pnpm store ç›®éŒ„
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: è¨­ç½® pnpm ç·©å­˜
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ç·¨è­¯ TypeScript è…³æœ¬
        run: pnpm run build:scripts

      - name: æ¸…ç†ç’°å¢ƒè®Šæ•¸
        run: |
          # æ¸…ç†æ‰€æœ‰ç’°å¢ƒè®Šæ•¸çš„æ›è¡Œç¬¦å’Œå›è»Šç¬¦
          echo "NEXT_PUBLIC_SUPABASE_URL=$(echo -n '${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$(echo -n '${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=$(echo -n '${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=$(echo -n '${{ secrets.OPENAI_API_KEY }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "DEEPSEEK_API_KEY=$(echo -n '${{ secrets.DEEPSEEK_API_KEY }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "ANTHROPIC_API_KEY=$(echo -n '${{ secrets.ANTHROPIC_API_KEY }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "OPENROUTER_API_KEY=$(echo -n '${{ secrets.OPENROUTER_API_KEY }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "PERPLEXITY_API_KEY=$(echo -n '${{ secrets.PERPLEXITY_API_KEY }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "R2_ACCESS_KEY_ID=$(echo -n '${{ secrets.R2_ACCESS_KEY_ID }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "R2_SECRET_ACCESS_KEY=$(echo -n '${{ secrets.R2_SECRET_ACCESS_KEY }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "R2_ACCOUNT_ID=$(echo -n '${{ secrets.R2_ACCOUNT_ID }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "R2_BUCKET_NAME=$(echo -n '${{ secrets.R2_BUCKET_NAME }}' | tr -d '\n\r')" >> $GITHUB_ENV
          echo "USE_MULTI_AGENT_ARCHITECTURE=$(echo -n '${{ secrets.USE_MULTI_AGENT_ARCHITECTURE }}' | tr -d '\n\r')" >> $GITHUB_ENV

      - name: é©—è­‰ç’°å¢ƒè®Šæ•¸
        run: |
          echo "ğŸ” æª¢æŸ¥å¿…è¦çš„ç’°å¢ƒè®Šæ•¸..."

          # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ˜¯å¦åŒ…å«æ›è¡Œç¬¦ï¼ˆæœƒå°è‡´ R2 å’Œ Multi-Agent å¤±æ•—ï¼‰
          check_env_var() {
            local var_name="$1"
            local var_value="${!var_name}"

            if [ -z "$var_value" ]; then
              echo "âŒ éŒ¯èª¤: $var_name æœªè¨­å®š"
              return 1
            fi

            # ä½¿ç”¨ printf è€Œä¸æ˜¯ echo ä¾†é¿å…è‡ªå‹•æ·»åŠ æ›è¡Œç¬¦
            if printf '%s' "$var_value" | grep -q $'\n'; then
              echo "âŒ éŒ¯èª¤: $var_name åŒ…å«æ›è¡Œç¬¦"
              return 1
            fi

            echo "âœ… $var_name: å·²è¨­å®šä¸”æ ¼å¼æ­£ç¢º"
            return 0
          }

          # æª¢æŸ¥æ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸
          all_valid=true

          # è³‡æ–™åº«ç›¸é—œ
          check_env_var "NEXT_PUBLIC_SUPABASE_URL" || all_valid=false
          check_env_var "NEXT_PUBLIC_SUPABASE_ANON_KEY" || all_valid=false
          check_env_var "SUPABASE_SERVICE_ROLE_KEY" || all_valid=false

          # AI API Keys
          check_env_var "OPENAI_API_KEY" || all_valid=false
          check_env_var "DEEPSEEK_API_KEY" || all_valid=false

          # R2 ç›¸é—œï¼ˆé‡è¦ï¼šä¸èƒ½æœ‰æ›è¡Œç¬¦ï¼‰
          check_env_var "R2_ACCESS_KEY_ID" || all_valid=false
          check_env_var "R2_SECRET_ACCESS_KEY" || all_valid=false
          check_env_var "R2_ACCOUNT_ID" || all_valid=false
          check_env_var "R2_BUCKET_NAME" || all_valid=false

          # Multi-Agent é–‹é—œ
          check_env_var "USE_MULTI_AGENT_ARCHITECTURE" || all_valid=false

          if [ "$all_valid" = false ]; then
            echo ""
            echo "âŒ ç’°å¢ƒè®Šæ•¸é©—è­‰å¤±æ•—ï¼è«‹æª¢æŸ¥ GitHub Secrets è¨­å®š"
            exit 1
          fi

          echo ""
          echo "âœ… æ‰€æœ‰ç’°å¢ƒè®Šæ•¸é©—è­‰é€šéï¼"

      - name: è™•ç†å–®å€‹æ–‡ç« ï¼ˆrepository_dispatchï¼‰
        if: github.event_name == 'repository_dispatch'
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          USE_MULTI_AGENT_ARCHITECTURE: ${{ secrets.USE_MULTI_AGENT_ARCHITECTURE }}
        run: |
          echo "è™•ç†æ–‡ç« : ${{ github.event.client_payload.title }}"
          echo "Job ID: ${{ github.event.client_payload.jobId }}"

          # åŸ·è¡Œæ–‡ç« ç”Ÿæˆè…³æœ¬
          node scripts/process-single-article.js \
            --jobId "${{ github.event.client_payload.jobId }}" \
            --title "${{ github.event.client_payload.title }}"

      - name: æ‰¹æ¬¡è™•ç†å¾…è™•ç†æ–‡ç« ï¼ˆscheduleï¼‰
        if: github.event_name == 'schedule'
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          USE_MULTI_AGENT_ARCHITECTURE: ${{ secrets.USE_MULTI_AGENT_ARCHITECTURE }}
        run: |
          echo "æ‰¹æ¬¡è™•ç†å¾…è™•ç†çš„æ–‡ç« ..."
          node scripts/process-batch-articles.js

      - name: æ‰‹å‹•åŸ·è¡Œï¼ˆworkflow_dispatchï¼‰
        if: github.event_name == 'workflow_dispatch'
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          USE_MULTI_AGENT_ARCHITECTURE: ${{ secrets.USE_MULTI_AGENT_ARCHITECTURE }}
        run: |
          if [ -n "${{ github.event.inputs.jobId }}" ]; then
            echo "è™•ç†æŒ‡å®šçš„ Job: ${{ github.event.inputs.jobId }}"
            node scripts/process-single-article.js --jobId "${{ github.event.inputs.jobId }}"
          else
            echo "æ‰¹æ¬¡è™•ç†æ‰€æœ‰å¾…è™•ç†æ–‡ç« "
            node scripts/process-batch-articles.js
          fi

      - name: ä¸Šå‚³æ—¥èªŒï¼ˆå¦‚æœå¤±æ•—ï¼‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            npm-debug.log
            yarn-error.log
          retention-days: 7