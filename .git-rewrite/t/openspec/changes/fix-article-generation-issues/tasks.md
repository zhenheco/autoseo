# Implementation Tasks

## 1. HTML 解析器遷移

- [ ] 1.1 檢查所有使用 jsdom 的程式碼位置
- [ ] 1.2 將 `html-agent.ts` 中所有 jsdom 動態導入替換為 linkedom
- [ ] 1.3 驗證 linkedom API 與 jsdom 的差異，調整程式碼
- [ ] 1.4 測試所有 HTML 解析功能（內部連結、內容格式化等）
- [ ] 1.5 從 `package.json` 移除 jsdom 依賴（如果沒有其他地方使用）
- [ ] 1.6 執行本地建置測試確認無錯誤

## 2. 語言選擇驗證

- [ ] 2.1 找出文章生成 API 入口點（`/api/articles/generate`）
- [ ] 2.2 加入語言參數驗證邏輯
- [ ] 2.3 實作錯誤訊息：「目前僅支援繁體中文」
- [ ] 2.4 更新前端表單，加入語言選擇下拉選單
- [ ] 2.5 預設語言為「繁體中文」
- [ ] 2.6 測試不同語言選擇的行為

## 3. 修正重複生成問題

- [ ] 3.1 追蹤 `orchestrator.ts` 中的文章生成邏輯
- [ ] 3.2 找出標題選擇的資料流（從前端到後端）
- [ ] 3.3 確認 `selectedTitle` 參數正確傳遞到所有 Agents
- [ ] 3.4 移除重複生成關鍵字文章的邏輯（如果存在）
- [ ] 3.5 加入斷言：僅生成用戶選擇的標題
- [ ] 3.6 測試標題選擇和生成流程

## 4. Token 計數系統實作

- [ ] 4.1 找出現有的 token 扣除服務或建立新服務
- [ ] 4.2 在每個 Agent 的 `execute` 方法中加入 token 記錄
- [ ] 4.3 實作 `deductTokens` 函數，更新 `companies.token_balance`
- [ ] 4.4 實作 `recordTokenUsage` 函數，記錄到 `token_usage` 表
- [ ] 4.5 在 `base-agent.ts` 中加入 token 追蹤邏輯
- [ ] 4.6 處理並行 Agent 的 token 批次扣除
- [ ] 4.7 測試 token 扣除的準確性和一致性

## 5. 前端 Token 顯示同步

- [ ] 5.1 找出前端顯示 token 餘額的組件
- [ ] 5.2 實作 API endpoint 查詢最新 token 餘額
- [ ] 5.3 加入定期輪詢機制（每 3 秒）或使用 WebSocket
- [ ] 5.4 在文章生成完成後刷新 token 顯示
- [ ] 5.5 測試多用戶同時生成時的顯示同步

## 6. 測試與驗證

- [ ] 6.1 執行完整的端到端測試（從前端到資料庫）
- [ ] 6.2 驗證 HTML 解析在 Vercel 環境中正常運作
- [ ] 6.3 驗證語言選擇驗證邏輯
- [ ] 6.4 驗證僅生成一篇文章（用戶選擇的標題）
- [ ] 6.5 驗證 token 數量在資料庫和前端正確更新
- [ ] 6.6 執行 `npm run build` 確認無 TypeScript 錯誤
- [ ] 6.7 部署到 Vercel 並驗證生產環境

## 7. 文件與清理

- [ ] 7.1 更新 `ISSUELOG.md` 記錄問題和修正
- [ ] 7.2 加入程式碼註解說明關鍵邏輯
- [ ] 7.3 清理未使用的程式碼和依賴
- [ ] 7.4 更新相關的 README 或開發者文件
