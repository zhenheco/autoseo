# Token Billing System - æœ€çµ‚ç‰ˆ

å®Œæ•´çš„ Token è¨ˆè²»ç³»çµ±ï¼Œæ”¯æ´å¤šæ¨¡å‹ AI ä½¿ç”¨é‡è¨ˆè²»ã€æœˆè²»è¨‚é–±ã€Token è³¼è²·åŒ…å’Œç¶“éŠ·å•†è¨ˆåŠƒã€‚

## ğŸ“‹ åŠŸèƒ½æ¸…å–®

### âœ… å·²å®Œæˆ
- **4 å€‹æœˆè²»æ–¹æ¡ˆ**ï¼šSTARTER / PROFESSIONAL / BUSINESS / AGENCY
- **çµ‚èº«æ–¹æ¡ˆ**ï¼šäº«æ¯æœˆé…é¡ + è³¼è²· Token æ°¸ä¹… 8 æŠ˜å„ªæƒ 
- **6 å€‹ Token è³¼è²·åŒ…**ï¼šå¾å…¥é–€åŒ…ï¼ˆ10K Tokenï¼‰åˆ°æ——è‰¦åŒ…ï¼ˆ1M Tokenï¼‰
- **Token åˆ†é›¢ç®¡ç†**ï¼š
  - `purchased_token_balance`ï¼šè³¼è²·çš„ Tokenï¼ˆæ°¸ä¸éæœŸï¼‰
  - `monthly_quota_balance`ï¼šæœˆè²»è´ˆé€çš„ Tokenï¼ˆæ¯æœˆé‡ç½®ï¼‰
  - **ä½¿ç”¨é †åº**ï¼šå…ˆç”¨ `purchased`ï¼Œå†ç”¨ `monthly_quota`
- **æ¨è–¦è¨ˆåŠƒ**ï¼š
  - è¨»å†Šçå‹µï¼š2,000 Token
  - é¦–è³¼çå‹µï¼šæ¨è–¦è€…ç²å¾—è¢«æ¨è–¦è€…é¦–æ¬¡ä»˜è²»é‡‘é¡ 20% çš„ Token
  - é¦–è³¼æŠ˜æ‰£ï¼šè¢«æ¨è–¦è€…é¦–æ¬¡è³¼è²· Token åŒ…äº« 8 æŠ˜
- **ç¶“éŠ·å•†ç³»çµ±**ï¼š
  - 20% ä½£é‡‘æ¯”ä¾‹ï¼ˆæ‰‹å‹•ç®¡ç†ï¼‰
  - ä½£é‡‘è¨˜éŒ„è¿½è¹¤
  - æ”¶ç›Šçµ±è¨ˆ
- **åŠŸèƒ½é™åˆ¶ç®¡ç†**ï¼šWordPress ç¶²ç«™æ•¸ã€é…åœ–æ•¸ã€åœ˜éšŠæˆå“¡æ•¸ç­‰

### ğŸš§ å¾…é–‹ç™¼ï¼ˆå¾ŒçºŒç‰ˆæœ¬ï¼‰
- è‡ªå‹•æ’ç¨‹ç³»çµ±ï¼ˆåŸºç¤/é€²éš/æ™ºæ…§ï¼‰
- æ‰¹é‡ç”Ÿæˆçå‹µ
- æ¯æœˆä½¿ç”¨é‡çå‹µ
- é€£çºŒä½¿ç”¨çå‹µ
- å­£ç¯€æ€§ä¿ƒéŠ·æ´»å‹•
- ç¶“éŠ·å•†ç­‰ç´šåˆ¶åº¦ï¼ˆéŠ…/éŠ€/é‡‘ï¼‰

## ğŸ’° å®šåƒ¹æ–¹æ¡ˆ

### æœˆè²»æ–¹æ¡ˆï¼ˆToken é…é¡ Ã—200%ï¼‰

| æ–¹æ¡ˆ | æœˆè²» | Token é…é¡ | åŠŸèƒ½äº®é» |
|------|------|-----------|---------|
| **STARTER** | NT$ 399 | 20,000 | 1å€‹WPç¶²ç«™ã€åŸºç¤AIæ¨¡å‹ã€åŸºç¤æ’ç¨‹ |
| **PROFESSIONAL** | NT$ 1,999 | 80,000 | 5å€‹WPç¶²ç«™ã€æ‰€æœ‰AIæ¨¡å‹ã€3äººåœ˜éšŠã€APIå­˜å– |
| **BUSINESS** | NT$ 4,999 | 240,000 | ç„¡é™WPç¶²ç«™ã€æ™ºæ…§æ’ç¨‹ã€10äººåœ˜éšŠ |
| **AGENCY** | NT$ 9,999 | 600,000 | æ‰€æœ‰åŠŸèƒ½ç„¡é™åˆ¶ã€ç™½æ¨™æœå‹™ |

### Token è³¼è²·åŒ…

| Token åŒ… | Token | åƒ¹æ ¼ | æ¯åƒ Token | çœå¤šå°‘ |
|---------|--------|---------|-----------|--------|
| å…¥é–€åŒ… | 10,000 | NT$ 99 | NT$ 9.9 | åŸºæº–åƒ¹ |
| æ¨™æº–åŒ… | 50,000 | NT$ 399 | NT$ 8.0 | çœ 19% |
| é€²éšåŒ… | 100,000 | NT$ 699 | NT$ 7.0 | çœ 29% |
| å°ˆæ¥­åŒ… | 300,000 | NT$ 1,799 | NT$ 6.0 | çœ 39% |
| ä¼æ¥­åŒ… | 500,000 | NT$ 2,499 | NT$ 5.0 | çœ 49% |
| æ——è‰¦åŒ… | 1,000,000 | NT$ 3,999 | NT$ 4.0 | çœ 60% |

### çµ‚èº«æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¸€æ¬¡æ€§è²»ç”¨ | æ¯æœˆ Token | å›æœ¬æœŸ | çµ‚èº«å„ªæƒ  |
|------|-----------|-----------|--------|---------|
| **çµ‚èº« STARTER** | NT$ 2,999 | 20,000 | 7.5å€‹æœˆ | è³¼è²· Token äº« 8 æŠ˜ |
| **çµ‚èº« PROFESSIONAL** | NT$ 9,999 | 80,000 | 5å€‹æœˆ | è³¼è²· Token äº« 8 æŠ˜ |
| **çµ‚èº« BUSINESS** | NT$ 29,999 | 240,000 | 6å€‹æœˆ | è³¼è²· Token äº« 8 æŠ˜ |

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### è³‡æ–™åº«è¡¨

```
subscription_plans              -- æœˆè²»æ–¹æ¡ˆï¼ˆå«åŠŸèƒ½é™åˆ¶ï¼‰
token_packages                  -- Token è³¼è²·åŒ…
company_subscriptions           -- ç”¨æˆ¶è¨‚é–±ç‹€æ…‹
token_usage_logs                -- Token ä½¿ç”¨è¨˜éŒ„
token_purchases                 -- Token è³¼è²·è¨˜éŒ„
token_balance_changes           -- Token é¤˜é¡è®Šå‹•è¨˜éŒ„
monthly_token_usage_stats       -- æœˆåº¦çµ±è¨ˆ
ai_model_pricing                -- AI æ¨¡å‹å®šåƒ¹
referrals                       -- æ¨è–¦é—œä¿‚
referral_rewards                -- æ¨è–¦çå‹µè¨˜éŒ„
company_referral_codes          -- å…¬å¸æ¨è–¦ç¢¼
resellers                       -- ç¶“éŠ·å•†è³‡æ–™
commissions                     -- ä½£é‡‘è¨˜éŒ„
```

### æœå‹™é¡åˆ¥

```typescript
TokenCalculator          // Token è¨ˆç®—å¼•æ“
TokenBillingService      // Token è¨ˆè²»æœå‹™ï¼ˆæ•´åˆ AI å‘¼å«ï¼‰
SubscriptionService      // è¨‚é–±ç®¡ç†æœå‹™
ReferralService          // æ¨è–¦è¨ˆåŠƒæœå‹™
ResellerService          // ç¶“éŠ·å•†ç®¡ç†æœå‹™
```

## ğŸ’» ä½¿ç”¨ç¯„ä¾‹

### 1. åˆå§‹åŒ–æœå‹™

```typescript
import { createClient } from '@/lib/supabase/server'
import {
  TokenBillingService,
  SubscriptionService,
  ReferralService,
  ResellerService
} from '@/lib/billing'

const supabase = await createClient()
const billingService = new TokenBillingService(supabase)
const subscriptionService = new SubscriptionService(supabase)
const referralService = new ReferralService(supabase)
const resellerService = new ResellerService(supabase)
```

### 2. æŸ¥è©¢å¯ç”¨æ–¹æ¡ˆ

```typescript
const plans = await subscriptionService.getAvailablePlans()

const { data: packages } = await supabase
  .from('token_packages')
  .select('*')
  .order('tokens', { ascending: true })
```

### 3. å»ºç«‹è¨‚é–±

```typescript
// æœˆè²»è¨‚é–±
const result = await subscriptionService.createSubscription(
  companyId,
  planId,
  false // isLifetime
)

// çµ‚èº«è¨‚é–±ï¼ˆ8 æŠ˜å„ªæƒ ï¼‰
const lifetimeResult = await subscriptionService.createSubscription(
  companyId,
  lifetimePlanId,
  true // isLifetime
)
```

### 4. ä½¿ç”¨ Token ç”Ÿæˆæ–‡ç« 

```typescript
import { AIClient } from '@/lib/ai/ai-client'

const aiClient = new AIClient({ apiKey: process.env.OPENROUTER_API_KEY })

// æª¢æŸ¥é¤˜é¡ï¼ˆç¸½é¤˜é¡ã€è³¼è²·çš„ã€æœˆé…é¡ï¼‰
const balance = await billingService.getCurrentBalance(companyId)
console.log(`ç¸½é¤˜é¡: ${balance.total}`)
console.log(`è³¼è²·çš„: ${balance.purchased}ï¼ˆå„ªå…ˆä½¿ç”¨ï¼‰`)
console.log(`æœˆé…é¡: ${balance.monthlyQuota}ï¼ˆç”¨å®Œè³¼è²·çš„å†ç”¨é€™å€‹ï¼‰`)

// åŸ·è¡Œä¸¦è‡ªå‹•æ‰£é™¤ï¼ˆå…ˆæ‰£ purchasedï¼Œå†æ‰£ monthly_quotaï¼‰
const result = await billingService.completeWithBilling(
  aiClient,
  companyId,
  userId,
  articleId,
  prompt,
  { model: 'claude-3-5-sonnet', temperature: 0.7 },
  'article_generation'
)

console.log(`å¯¦éš›æ‰£é™¤: ${result.billing.chargedTokens} tokens`)
console.log(`æ–°é¤˜é¡: ${result.billing.balanceAfter}`)
```

### 5. è³¼è²· Token åŒ…

```typescript
// ä¸€èˆ¬è³¼è²·
const purchaseResult = await subscriptionService.purchaseTokenPackage(
  companyId,
  packageId,
  paymentId
)

// çµ‚èº«æœƒå“¡è‡ªå‹•äº« 8 æŠ˜
```

### 6. æ¨è–¦è¨ˆåŠƒ

```typescript
// å–å¾—æ¨è–¦ç¢¼
const myCode = await referralService.getReferralCode(companyId)

// é©—è­‰æ¨è–¦ç¢¼ä¸¦å»ºç«‹æ¨è–¦é—œä¿‚
const validation = await referralService.validateReferralCode('ABCD1234')
if (validation.valid) {
  await referralService.createReferral(
    validation.companyId!,
    newCompanyId,
    'ABCD1234'
  )
}

// é¦–æ¬¡ä»˜è²»è§¸ç™¼æ¨è–¦çå‹µ
await referralService.processFirstPayment(
  referredCompanyId,
  paymentAmount
)
```

### 7. ç¶“éŠ·å•†ç®¡ç†ï¼ˆæ‰‹å‹•ï¼‰

```typescript
// æŸ¥è©¢ç¶“éŠ·å•†è³‡æ–™
const reseller = await resellerService.getReseller(companyId)
console.log(`ä½£é‡‘æ¯”ä¾‹: ${reseller.commissionRate * 100}%`)

// å»ºç«‹ä½£é‡‘è¨˜éŒ„
const result = await resellerService.createCommission({
  resellerId: reseller.id,
  orderType: 'subscription',
  orderId: subscriptionId,
  customerCompanyId: customerId,
  orderAmount: 1999
})

// æŸ¥è©¢ä½£é‡‘è¨˜éŒ„
const commissions = await resellerService.getCommissions(reseller.id, {
  status: 'pending',
  limit: 10
})

// æ ¸å‡†ä½£é‡‘
await resellerService.approveCommission(commissionId, 'å·²å¯©æ ¸é€šé')

// æ”¯ä»˜ä½£é‡‘
await resellerService.payCommission(commissionId, 'å·²åŒ¯æ¬¾')

// æŸ¥è©¢æ”¶ç›Š
const earnings = await resellerService.getTotalEarnings(reseller.id)
console.log(`å¾…å¯©æ ¸: ${earnings.pending}`)
console.log(`å·²æ ¸å‡†: ${earnings.approved}`)
console.log(`å·²æ”¯ä»˜: ${earnings.paid}`)
```

## ğŸ“Š è¨ˆè²»å…¬å¼

### Token è¨ˆç®—

```
charged_tokens = official_tokens Ã— model_multiplier Ã— 2.0

ç¯„ä¾‹ï¼š
- DeepSeek-Chat (1x): 1000 å®˜æ–¹ â†’ 2000 charged
- Claude 3.5 (2x): 1000 å®˜æ–¹ â†’ 4000 charged
```

### æ¨¡å‹åˆ†é¡

**åŸºç¤æ¨¡å‹ï¼ˆ1xï¼‰**ï¼š
- `gemini-2-flash`
- `deepseek-chat`
- `gpt-5-mini`

**é€²éšæ¨¡å‹ï¼ˆ2xï¼‰**ï¼š
- `gemini-2.5-pro`
- `deepseek-reasoner`
- `gpt-5`
- `claude-3-5-sonnet`
- `claude-4-5-sonnet`

## ğŸ¯ åŠŸèƒ½é™åˆ¶

| åŠŸèƒ½ | STARTER | PRO | BUSINESS | AGENCY |
|------|---------|-----|----------|--------|
| WordPress ç¶²ç«™ | 1å€‹ | 5å€‹ | ç„¡é™ | ç„¡é™ |
| é…åœ–/ç¯‡ | 1-3 | 1-5 | ç„¡é™ | ç„¡é™ |
| AI æ¨¡å‹ | åŸºç¤ | å…¨éƒ¨ | å…¨éƒ¨ | å…¨éƒ¨ |
| æ’ç¨‹ç³»çµ± | åŸºç¤ | é€²éš | æ™ºæ…§ | æ™ºæ…§ |
| å“ç‰Œè²éŸ³ | 0å€‹ | 1å€‹ | 3å€‹ | ç„¡é™ |
| åœ˜éšŠå”ä½œ | 1äºº | 3äºº | 10äºº | ç„¡é™ |
| API å­˜å– | âŒ | âœ… | âœ… | âœ… |
| ç™½æ¨™æœå‹™ | âŒ | âŒ | âŒ | âœ… |

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. åŸ·è¡Œ Migration

```bash
# åŸ·è¡Œæœ€çµ‚å®šåƒ¹æ›´æ–°
supabase migration up 20251030120000_final_pricing_update.sql
```

### 2. é©—è­‰è³‡æ–™

```sql
-- æª¢æŸ¥æ–¹æ¡ˆï¼ˆæ‡‰è©²æœ‰ 7 å€‹ï¼‰
SELECT name, monthly_price, base_tokens, is_lifetime, lifetime_price
FROM subscription_plans
ORDER BY is_lifetime, monthly_price;

-- æª¢æŸ¥ Token åŒ…ï¼ˆæ‡‰è©²æœ‰ 6 å€‹ï¼‰
SELECT name, tokens, price
FROM token_packages
ORDER BY tokens;
```

### 3. æ–°å¢ç¶“éŠ·å•†ï¼ˆæ‰‹å‹•ï¼‰

```sql
-- æ–°å¢ç¶“éŠ·å•†
INSERT INTO resellers (company_id, commission_rate, status, notes)
VALUES ('company-uuid-here', 0.200, 'active', 'åˆæœŸç¶“éŠ·å•†');
```

## ğŸ” å®‰å…¨æ€§

- âœ… Row Level Security (RLS) å·²å•Ÿç”¨
- âœ… Token æ‰£é™¤ä½¿ç”¨ transaction ä¿è­‰åŸå­æ€§
- âœ… ç¶“éŠ·å•†è³‡æ–™åƒ…è‡ªå·±å¯è¦‹
- âœ… ä½£é‡‘è¨˜éŒ„æœ‰å®Œæ•´çš„å¯©æ ¸æµç¨‹

## ğŸ“ é‡è¦æ³¨æ„äº‹é …

1. **Token ä½¿ç”¨é †åº**ï¼š**å…ˆæ‰£ `purchased_token_balance`ï¼Œå†æ‰£ `monthly_quota_balance`**
2. **æœˆé…é¡é‡ç½®**ï¼šæ¯æœˆé‡ç½®æ­¸é›¶ï¼Œä¸ç´¯ç©
3. **çµ‚èº«æ–¹æ¡ˆå„ªæƒ **ï¼šè³¼è²· Token åŒ…è‡ªå‹•äº« 8 æŠ˜ï¼ˆ`lifetime_discount = 0.8`ï¼‰
4. **æ¨è–¦çå‹µ**ï¼šè¨»å†Šç«‹å³çµ¦ 2,000 Tokenï¼Œé¦–æ¬¡ä»˜è²»å¾Œæ¨è–¦è€…ç²å¾— 20% ä½£é‡‘
5. **ç¶“éŠ·å•†ä½£é‡‘**ï¼šåˆæœŸçµ±ä¸€ 20%ï¼Œæ‰‹å‹•ç®¡ç†
6. **Token æ°¸ä¸éæœŸ**ï¼šè³¼è²·çš„ Token æ°¸ä¹…æœ‰æ•ˆ

## ğŸ”„ å¾ŒçºŒé–‹ç™¼

1. **è‡ªå‹•æ’ç¨‹ç³»çµ±**
   - åŸºç¤æ’ç¨‹ï¼ˆ7å¤©ï¼‰
   - é€²éšæ’ç¨‹ï¼ˆ30å¤©ï¼‰
   - æ™ºæ…§æ’ç¨‹ï¼ˆç„¡é™ï¼ŒGAå„ªåŒ–ï¼‰

2. **çå‹µæ©Ÿåˆ¶**
   - æ‰¹é‡ç”Ÿæˆçå‹µï¼ˆ5%-20%ï¼‰
   - æ¯æœˆä½¿ç”¨é‡çå‹µ
   - é€£çºŒä½¿ç”¨çå‹µï¼ˆ3/6/12/24å€‹æœˆï¼‰

3. **ç¶“éŠ·å•†å‡ç´š**
   - ç­‰ç´šåˆ¶åº¦ï¼ˆéŠ…/éŠ€/é‡‘ï¼‰
   - ç´¯é€²å¼ä½£é‡‘
   - è‡ªå‹•åŒ–å¯©æ ¸

4. **å‰ç«¯ UI**
   - è¨‚é–±æ–¹æ¡ˆé¸æ“‡é 
   - Token è³¼è²·é 
   - æ¨è–¦ç¢¼åˆ†äº«é 
   - ç¶“éŠ·å•†å¾Œå°
