# Excel 多欄位檔案上傳與解析

**Capability**: `excel-upload`
**Version**: 2.0.0
**Status**: 提案中（已更新）

## 概述

提供 Excel 檔案上傳功能，支援多欄位格式（關鍵字、網站、類型、時間），並在前端即時解析和驗證，顯示完整的發佈計畫列表。

---

## ADDED Requirements

### Requirement: 支援 Excel 檔案上傳

系統 MUST 提供檔案上傳介面，支援 .xlsx 和 .xls 格式的 Excel 檔案。

#### Scenario: 使用者拖放 Excel 檔案

**Given** 使用者在文章匯入頁面
**When** 使用者拖放一個 .xlsx 檔案到上傳區域
**Then** 系統顯示檔案名稱和大小
**And** 系統開始解析檔案內容

#### Scenario: 使用者選擇本機檔案

**Given** 使用者在文章匯入頁面
**When** 使用者點擊「選擇檔案」按鈕並選擇一個 .xls 檔案
**Then** 系統顯示檔案資訊
**And** 系統自動開始解析

#### Scenario: 上傳不支援的檔案格式

**Given** 使用者在上傳區域
**When** 使用者嘗試上傳 .csv 或 .txt 檔案
**Then** 系統顯示錯誤訊息：「僅支援 .xlsx 和 .xls 格式」
**And** 系統不進行檔案解析

---

### Requirement: Excel 多欄位內容解析

系統 MUST 能夠解析 Excel 檔案的第一個工作表，提取四個欄位：關鍵字（必填）、網站名稱（必填）、文章類型（選填）、發佈時間（選填）。

**標準格式**:
| 關鍵字 | 網站名稱 | 文章類型 | 發佈時間 |
|--------|----------|----------|----------|
| Next.js 教學 | 技術部落格 | 教學 | 2025-11-15 10:00 |

#### Scenario: 解析完整格式的 Excel 檔案

**Given** Excel 檔案包含四欄資料
**When** 系統解析檔案
**Then** 系統提取所有四欄的內容
**And** 系統驗證關鍵字和網站名稱非空白
**And** 系統顯示成功解析的行數

#### Scenario: 解析部分欄位的 Excel

**Given** Excel 檔案僅包含關鍵字和網站名稱兩欄
**When** 系統解析檔案
**Then** 系統成功提取關鍵字和網站名稱
**And** 系統將文章類型和發佈時間設為 null
**And** 系統標記這些欄位為「待自動判斷」或「待設定」

#### Scenario: 解析包含標題列的 Excel

**Given** Excel 第一列是標題（「關鍵字」、「網站名稱」等）
**When** 系統解析檔案
**Then** 系統自動識別標題列
**And** 系統從第二列開始提取資料
**And** 系統根據標題列自動對應欄位順序

#### Scenario: 解析包含空白列的 Excel

**Given** Excel 檔案中間有空白列
**When** 系統解析檔案
**Then** 系統自動過濾空白列
**And** 系統僅保留有效的資料行

---

### Requirement: 發佈計畫列表預覽與編輯

系統 MUST 提供完整的發佈計畫列表預覽介面，顯示關鍵字、網站名稱、文章類型、發佈時間、狀態和發佈網址。

**列表欄位**:
- 序號
- 關鍵字
- 網站名稱
- 文章類型
- 發佈時間
- 狀態（待處理/生成中/已完成/已發佈）
- 發佈網址（發佈後顯示）

#### Scenario: 顯示發佈計畫列表

**Given** 系統成功解析 Excel 檔案
**When** 系統顯示預覽介面
**Then** 系統以表格形式顯示所有發佈計畫
**And** 每一行顯示完整的欄位資訊
**And** 系統顯示總計畫數量

#### Scenario: 網站名稱驗證與提示

**Given** 系統解析出網站名稱「技術部落格」
**When** 系統驗證網站名稱
**Then** 系統查詢當前公司的所有網站配置
**And** 若找到匹配的網站則顯示綠色勾選圖示
**And** 若無匹配則顯示警告圖示並提示使用者

#### Scenario: 編輯單個計畫項目

**Given** 使用者在預覽介面
**When** 使用者點擊某一行的「編輯」按鈕
**Then** 系統顯示編輯對話框
**And** 使用者可修改關鍵字、網站、類型、時間
**And** 點擊「儲存」後更新列表

#### Scenario: 刪除單個計畫項目

**Given** 使用者在預覽介面
**When** 使用者點擊某一行的「刪除」按鈕
**Then** 系統從列表中移除該計畫
**And** 系統更新總數量

#### Scenario: 批次刪除計畫項目

**Given** 使用者在預覽介面
**When** 使用者勾選多個計畫並點擊「批次刪除」
**Then** 系統移除所有被選中的計畫
**And** 系統更新總數量

---

### Requirement: 檔案大小與數量限制

系統 MUST 限制 Excel 檔案大小和計畫數量，避免效能問題和排程負擔。

#### Scenario: 上傳超過大小限制的檔案

**Given** 系統設定最大檔案大小為 5MB
**When** 使用者上傳 10MB 的 Excel 檔案
**Then** 系統顯示錯誤訊息：「檔案大小超過限制（最大 5MB）」
**And** 系統不進行解析

#### Scenario: 解析超過數量限制的計畫

**Given** 系統設定最大計畫數量為 500 個
**When** Excel 檔案包含 800 個計畫
**Then** 系統僅提取前 500 個計畫
**And** 系統顯示警告訊息：「已達到最大數量限制（500 個），部分計畫未匯入」

---

### Requirement: 網站名稱智慧對應

系統 MUST 提供網站名稱到 website_id 的智慧對應功能，支援模糊匹配和建議。

#### Scenario: 精確匹配網站名稱

**Given** Excel 中的網站名稱為「技術部落格」
**And** 資料庫中存在 website_name 為「技術部落格」的記錄
**When** 系統進行網站對應
**Then** 系統成功對應到該網站的 website_id
**And** 系統在列表中顯示綠色勾選圖示

#### Scenario: 模糊匹配網站名稱

**Given** Excel 中的網站名稱為「技術部落」
**And** 資料庫中存在 website_name 為「技術部落格」的記錄
**When** 系統進行網站對應
**Then** 系統使用模糊匹配找到最接近的網站
**And** 系統顯示黃色警告圖示和建議：「您是否要使用『技術部落格』？」

#### Scenario: 無法對應網站名稱

**Given** Excel 中的網站名稱為「新網站」
**And** 資料庫中不存在匹配的網站
**When** 系統進行網站對應
**Then** 系統顯示紅色錯誤圖示
**And** 系統提示：「找不到網站『新網站』，請先在網站管理中建立」
**And** 該計畫標記為「需要處理」

---

### Requirement: 錯誤處理與使用者回饋

系統 MUST 處理各種錯誤情況並提供清晰的使用者回饋。

#### Scenario: 解析損壞的 Excel 檔案

**Given** 使用者上傳一個損壞的 .xlsx 檔案
**When** 系統嘗試解析檔案
**Then** 系統顯示錯誤訊息：「無法讀取檔案，請確認檔案格式正確」
**And** 系統允許使用者重新上傳

#### Scenario: 解析空白的 Excel 檔案

**Given** Excel 檔案不包含任何資料
**When** 系統解析檔案
**Then** 系統顯示警告訊息：「未找到有效的關鍵字」
**And** 系統提示使用者重新上傳或手動輸入

---

## 技術規格

### 前端實作

- **套件**: `xlsx` (SheetJS)
- **檔案讀取**: FileReader API
- **最大檔案大小**: 5MB
- **最大關鍵字數量**: 1000 個
- **支援格式**: `.xlsx`, `.xls`

### 資料驗證

- 關鍵字長度：1-200 字元
- 自動過濾空白和重複關鍵字
- 清理特殊字元（保留中文、英文、數字、空格）

### UI 元件

- 拖放上傳區域 (Drag & Drop Zone)
- 檔案資訊顯示卡
- 關鍵字預覽表格 (Tanstack Table)
- 編輯/刪除操作按鈕
- 進度指示器

---

## 相依性

- 前端套件: `xlsx`, `react-hook-form`, `@tanstack/react-table`
- UI 元件庫: `shadcn/ui`
- 無後端 API 相依（完全在前端處理）

---

## 測試考量

- 測試不同 Excel 格式 (.xlsx, .xls)
- 測試不同工作表結構（單欄、多欄、空白列）
- 測試檔案大小限制
- 測試錯誤處理（損壞檔案、空白檔案）
- 測試關鍵字編輯功能（新增、刪除、批次操作）
