# 實作任務清單：Excel 自動化文章批次匯入系統

## 階段 1: 資料庫擴充

### Task 1.1: 新增 article_jobs 表欄位
- [x] 建立資料庫 migration 檔案
- [x] 新增 `article_type` 欄位（TEXT, CHECK constraint）
- [x] 新增 `scheduled_publish_at` 欄位（TIMESTAMPTZ）
- [x] 新增 `published_url` 欄位（TEXT）
- [x] 執行 migration 並驗證
- **驗證**: ✅ 查詢表結構，確認新欄位存在
- **預估時間**: 15 分鐘

---

## 階段 2: 基礎設施準備

### Task 2.1: 安裝前端相依套件
- [x] 安裝 `xlsx` 套件
- [x] 更新 `package.json`
- [x] 執行 `npm install`
- **驗證**: ✅ `npm list xlsx` 顯示已安裝版本
- **預估時間**: 5 分鐘

### Task 2.2: 建立檔案上傳頁面路由
- [x] 建立 `/app/(dashboard)/dashboard/articles/import/page.tsx`
- [ ] 設定頁面 metadata 和權限（待前端測試）
- [ ] 加入導航連結到側邊欄（「批次匯入」）
- **驗證**: ⏳ 瀏覽器訪問 `/dashboard/articles/import` 正常顯示
- **預估時間**: 15 分鐘

---

## 階段 3: Excel 多欄位解析

### Task 3.1: 實作檔案上傳元件
- [x] 建立 `@/components/articles/ExcelUploadZone.tsx`
- [x] 實作拖放功能
- [x] 實作檔案選擇按鈕
- [x] 加入檔案格式和大小驗證
- **驗證**: ✅ 可上傳 Excel 檔案
- **預估時間**: 30 分鐘

### Task 3.2: 實作多欄位 Excel 解析
- [x] 建立 `@/lib/utils/excel-parser.ts`
- [x] 實作 `parseMultiColumnExcel` 函式
- [x] 解析五欄：關鍵字、網站名稱、文章類型、發佈時間、自訂 Slug
- [x] 自動識別標題列
- [x] 支援欄位順序自動對應
- [x] 驗證必填欄位（關鍵字、網站名稱）
- [x] 過濾空白列
- [x] 限制最多 500 個計畫
- **驗證**: ✅ 單元測試通過，解析範例 Excel 正確
- **預估時間**: 60 分鐘

### Task 3.3: 實作網站名稱智慧對應
- [x] 建立 `@/lib/utils/website-matcher.ts`
- [x] 實作精確匹配邏輯
- [x] 實作模糊匹配邏輯（使用 Levenshtein distance）
- [x] 回傳對應結果和建議
- **驗證**: ✅ 測試不同網站名稱的對應準確率
- **預估時間**: 45 分鐘

---

## 階段 4: URL Slug 管理系統

### Task 4.1: 安裝 Slug 相關套件
- [x] 安裝 `slugify` 套件
- [x] 安裝 `pinyin-pro` 套件（中文拼音轉換）
- [x] 更新 `package.json`
- **驗證**: ✅ 套件成功安裝並可導入
- **預估時間**: 5 分鐘

### Task 4.2: 實作 Slug 生成核心邏輯
- [x] 建立 `@/lib/services/slug-generator.ts`
- [x] 實作 `generatePinyinSlug` 函式（中文轉拼音）
- [x] 實作 `generateEnglishSlug` 函式（提取英文關鍵字）
- [x] 實作 `generateSlug` 函式（自動判斷策略）
- [x] 支援四種策略：auto、pinyin、english、custom
- [x] 遵循 SEO 優化規則（長度限制、小寫、移除停用詞）
- **驗證**: ✅ 單元測試通過，各策略正確生成 slug
- **預估時間**: 60 分鐘

### Task 4.3: 實作 Slug 唯一性保證
- [x] 實作 `ensureUniqueSlug` 函式（衝突時自動加編號）
- [x] 加入資料庫查詢（檢查 website_id + slug 組合）
- [x] 實作增量命名邏輯（slug-1, slug-2 等）
- **驗證**: ✅ 測試衝突處理，確保唯一性
- **預估時間**: 30 分鐘

### Task 4.4: 擴充 website_configs 資料表
- [x] 建立 migration 檔案（新增 slug 相關欄位）
- [x] 新增 `base_url` 欄位（TEXT NOT NULL DEFAULT ''）
- [x] 新增 `slug_prefix` 欄位（TEXT DEFAULT ''）
- [x] 新增 `url_strategy` 欄位（TEXT DEFAULT 'relative'）
- [x] 新增 `default_slug_strategy` 欄位（TEXT DEFAULT 'auto'）
- [x] 執行 migration 並驗證
- **驗證**: ✅ 資料表結構正確，欄位存在
- **預估時間**: 20 分鐘

### Task 4.5: 實作 URL 組裝邏輯
- [x] 整合至 `@/lib/services/slug-generator.ts`
- [x] 實作 `assemblePublishURL` 函式
- [x] 支援 base_url + slug_prefix + slug 組合
- [x] 處理斜線正規化（避免雙斜線）
- [x] 實作 URL 預覽功能
- **驗證**: ✅ 生成正確格式的完整 URL
- **預估時間**: 20 分鐘

### Task 4.6: 整合 Slug 到 article_jobs
- [x] 擴充 `article_jobs` 表（新增 slug 和 slug_strategy 欄位）
- [x] 加入唯一約束 `UNIQUE (website_id, slug)`
- [x] 建立索引 `idx_article_jobs_website_slug`
- [x] 建立索引 `idx_published_articles` (filtered index)
- **驗證**: ✅ 約束生效，無法插入重複 slug
- **預估時間**: 15 分鐘

---

## 階段 5: 發佈計畫列表介面

### Task 5.1: 建立發佈計畫列表元件
- [x] 建立 `@/components/articles/PublishPlanTable.tsx`
- [x] 使用 Table 元件顯示列表
- [x] 定義欄位：序號、關鍵字、網站、slug、類型、時間、狀態、URL 預覽
- [x] 加入網站驗證狀態圖示（綠色勾選/黃色警告/紅色錯誤）
- [x] 顯示 slug 預覽和完整 URL 預覽
- **驗證**: ✅ 顯示完整的發佈計畫列表
- **預估時間**: 60 分鐘

### Task 5.2: 實作列表編輯功能
- [x] 加入批次刪除功能
- [ ] 加入「編輯」按鈕和對話框（Phase 2）
- [ ] 允許修改關鍵字、網站、類型、時間、自訂 slug（Phase 2）
- [ ] 即時更新 URL 預覽（Phase 2）
- **驗證**: ⏳ 可編輯和刪除計畫項目
- **預估時間**: 45 分鐘

### Task 5.3: 實作排程設定介面
- [x] 建立 `@/components/articles/ScheduleSettings.tsx`
- [x] 提供固定間隔設定（輸入小時數）
- [x] 顯示預覽：列出所有計畫的預計發佈時間
- [ ] 加入時間衝突檢測和警告（Phase 2）
- **驗證**: ✅ 可設定間隔並預覽排程
- **預估時間**: 45 分鐘

---

## 階段 6: 自動標題生成

### Task 6.1: 實作自動標題生成 API
- [ ] 建立 `@/lib/services/auto-title-generator.ts`
- [ ] 實作單個標題生成函式（根據關鍵字和類型）
- [ ] 實作重試機制（最多 3 次）
- [ ] 失敗時回退到使用關鍵字作為標題
- **驗證**: 生成的標題符合品質標準
- **預估時間**: 45 分鐘

### Task 6.2: 實作批次標題生成邏輯
- [ ] 批次生成所有計畫的標題
- [ ] 並發控制（最多 5 個並發）
- [ ] 進度追蹤和回饋
- **驗證**: 可為 100 個計畫生成標題
- **預估時間**: 30 分鐘

---

## 階段 7: 文章類型智慧判斷

### Task 7.1: 建立文章類型判斷 API
- [ ] 建立 `/app/api/articles/determine-type/route.ts`
- [ ] 實作 AI 判斷邏輯（分析關鍵字）
- [ ] 支援四種類型：教學、排行榜、比較、資訊型
- [ ] 實作混合模式邏輯（Excel 優先）
- **驗證**: API 可正確判斷文章類型
- **預估時間**: 45 分鐘

### Task 7.2: 整合文章類型到生成策略
- [ ] 修改 `strategy-agent.ts`
- [ ] 根據 `article_type` 調整寫作策略
- [ ] 為每種類型定義專屬 prompt
- **驗證**: 不同類型生成不同風格的文章
- **預估時間**: 30 分鐘

---

## 階段 8: 批次任務建立 API

### Task 8.1: 建立批次匯入 API
- [x] 建立 `/app/api/articles/import-batch/route.ts`
- [x] 接收發佈計畫列表和排程設定
- [x] 處理網站名稱對應
- [ ] 批次生成標題（每個關鍵字 1 個）（Phase 2）
- [ ] 判斷文章類型（若未填）（Phase 2）
- [x] 生成或驗證 slug（確保唯一性）
- [x] 組裝 URL 預覽（base_url + slug_prefix + slug）
- [x] 計算排程時間（固定間隔或指定時間）
- [x] 批次插入 `article_jobs`
- [x] 建立 `/app/api/websites/route.ts`（獲取網站列表）
- **驗證**: ✅ API 可批次建立任務，slug 唯一
- **預估時間**: 75 分鐘

### Task 8.2: Token 餘額預檢
- [ ] 預估批次任務的總 token 消耗（標題+類型+slug）（Phase 2）
- [ ] 檢查當前餘額（Phase 2）
- [ ] 餘額不足時回傳錯誤（Phase 2）
- **驗證**: ⏳ 餘額不足時正確拒絕
- **預估時間**: 20 分鐘

### Task 8.3: 實作內部連結邏輯
- [ ] 建立 `@/lib/services/internal-links-generator.ts`（Phase 2）
- [ ] 實作 `findRelatedArticles` 函式（使用 AI 分析相關性）（Phase 2）
- [ ] 實作 `insertLinkIntoContent` 函式（插入連結到內容）（Phase 2）
- [ ] 支援相對路徑和絕對路徑（根據 url_strategy）（Phase 2）
- [ ] 限制每篇文章 3-5 個內部連結（Phase 2）
- **驗證**: ⏳ 生成的文章包含相關內部連結
- **預估時間**: 45 分鐘

---

## 階段 9: 排程系統實作

### Task 9.1: 建立排程處理器
- [ ] 建立 `@/lib/scheduler/article-scheduler.ts`
- [ ] 實作取得待處理任務邏輯（查詢 `scheduled_publish_at <= NOW()`）
- [ ] 實作任務觸發邏輯
- [ ] 實作並發控制（最多 5 個並發）
- **驗證**: 可正確取得和執行排程任務
- **預估時間**: 45 分鐘

### Task 9.2: 整合 GitHub Actions Cron
- [ ] 建立 `.github/workflows/process-scheduled-articles.yml`
- [ ] 設定 cron 排程（每 10 分鐘）
- [ ] 建立 API 端點 `/api/cron/process-scheduled-articles`
- [ ] 實作觸發邏輯
- **驗證**: Cron Job 定時執行
- **預估時間**: 30 分鐘

### Task 9.3: 時區處理
- [ ] 確保所有時間使用 UTC
- [ ] 前端顯示時轉換為本地時區
- [ ] 測試不同時區的排程準確性
- **驗證**: 排程時間準確無誤
- **預估時間**: 20 分鐘

---

## 階段 10: 發佈狀態追蹤

### Task 10.1: 實作即時狀態更新
- [ ] 修改文章生成 API，更新狀態為 `generating`
- [ ] 完成後更新為 `completed`
- [ ] 發佈時更新為 `publishing`
- [ ] 成功後更新為 `published` 並儲存網址
- [ ] 失敗時更新為 `failed` 並記錄錯誤
- **驗證**: 狀態正確追蹤
- **預估時間**: 30 分鐘

### Task 10.2: 前端即時更新
- [ ] 使用 Supabase Realtime 訂閱狀態變更
- [ ] 即時更新列表中的狀態欄位和 URL
- [ ] 顯示進度指示器
- **驗證**: 前端即時反映狀態變化
- **預估時間**: 30 分鐘

### Task 10.3: 發佈網址顯示
- [ ] 發佈成功後更新 `published_url` 欄位
- [ ] 列表中顯示可點擊的完整 URL 連結
- [ ] 加入「在新視窗開啟」功能
- [ ] 顯示 slug 和完整 URL
- **驗證**: 可點擊網址並開啟發佈的文章
- **預估時間**: 15 分鐘

---

## 階段 11: 錯誤處理與重試

### Task 11.1: 實作發佈重試機制
- [ ] 建立重試 API `/api/articles/jobs/[id]/retry`
- [ ] 檢查任務狀態為 `failed`
- [ ] 重新執行生成或發佈流程
- [ ] 更新狀態
- **驗證**: 可手動重試失敗任務
- **預估時間**: 30 分鐘

### Task 11.2: 實作錯誤訊息顯示
- [ ] 失敗時在列表中顯示錯誤圖示
- [ ] 點擊圖示顯示詳細錯誤訊息
- [ ] 提供重試按鈕
- **驗證**: 可查看錯誤詳情並重試
- **預估時間**: 20 分鐘

---

## 階段 12: 整合測試與優化

### Task 12.1: 端到端整合測試
- [ ] 測試完整流程：上傳 → 解析 → slug 生成 → 排程 → 生成 → 發佈 → 網址顯示
- [ ] 測試不同 Excel 格式（完整五欄/部分欄位/含自訂 slug）
- [ ] 測試不同排程模式（指定時間/固定間隔/混合）
- [ ] 測試 slug 唯一性（衝突處理）
- [ ] 測試錯誤情況（網站不存在、餘額不足、發佈失敗）
- **驗證**: 所有情況正常運作
- **預估時間**: 120 分鐘

### Task 12.2: 效能優化
- [ ] 優化大量計畫解析速度
- [ ] 優化批次標題和 slug 生成並發數
- [ ] 實作列表虛擬化（超過 100 個計畫）
- [ ] 加入請求快取
- [ ] 優化資料庫查詢（slug 唯一性檢查）
- **驗證**: 大量計畫處理流暢（500 個 < 30 秒）
- **預估時間**: 60 分鐘

### Task 12.3: 撰寫單元測試
- [ ] 測試 Excel 五欄位解析邏輯
- [ ] 測試網站名稱智慧對應
- [ ] 測試標題生成與重試
- [ ] 測試文章類型判斷
- [ ] 測試 slug 生成（所有策略）
- [ ] 測試 slug 唯一性保證
- [ ] 測試 URL 組裝邏輯
- [ ] 測試排程計算邏輯
- [ ] 測試內部連結生成
- **驗證**: 所有測試通過（覆蓋率 > 80%）
- **預估時間**: 90 分鐘

### Task 12.4: 建立範例 Excel 檔案
- [ ] 建立標準五欄格式範例檔案
- [ ] 建立部分欄位範例檔案（僅關鍵字+網站）
- [ ] 建立自訂 slug 範例檔案
- [ ] 提供下載連結
- [ ] 撰寫詳細使用說明（含 slug 規則說明）
- **驗證**: 使用者可下載並使用範例
- **預估時間**: 30 分鐘

---

## 階段 13: 部署與驗證

### Task 13.1: Lint 和 Typecheck
- [ ] 執行 `npm run lint` 並修復錯誤
- [ ] 執行 `npm run typecheck` 並修復類型錯誤
- [ ] 確認沒有使用 `any` 類型
- **驗證**: 無錯誤和警告
- **預估時間**: 30 分鐘

### Task 13.2: 建立功能分支並提交
- [ ] 建立分支 `feature/excel-auto-import`
- [ ] 提交所有更改（頻繁 commit）
- [ ] 推送到遠端
- **驗證**: 分支存在於遠端
- **預估時間**: 10 分鐘

### Task 13.3: 本地完整驗證
- [ ] 執行 `npm run build`
- [ ] 測試完整流程（上傳 → slug 生成 → 排程 → 執行）
- [ ] 檢查資料庫記錄（驗證 slug 唯一性）
- [ ] 檢查發佈結果和 URL
- [ ] 驗證內部連結正常運作
- **驗證**: 建置成功，功能完整
- **預估時間**: 45 分鐘

### Task 13.4: 部署到 Vercel 並驗證
- [ ] 部署到 Vercel
- [ ] 在生產環境測試功能
- [ ] 檢查 Vercel 日誌
- [ ] 驗證 GitHub Actions Cron Job 正常運作
- [ ] 驗證 URL 組裝和內部連結
- **驗證**: 生產環境功能正常
- **預估時間**: 45 分鐘

---

## 相依性與順序

**必須順序執行**:
- 階段 1 → 階段 2（資料庫擴充必須先完成）
- 階段 3 → 階段 4（Excel 解析後才能處理 slug）
- 階段 4 → 階段 5（Slug 系統準備好才能顯示預覽）
- 階段 6, 7, 8 可並行（獨立功能，但需要階段 4 完成）
- 階段 9 → 階段 10（排程後才能追蹤）
- 階段 12 → 階段 13（測試後才能部署）

**可並行執行**:
- Task 4.2 和 Task 4.3 可並行（slug 生成和唯一性檢查獨立）
- Task 6.1 和 Task 7.1 可並行（獨立 API）
- Task 9.1, 9.2, 9.3 可並行
- Task 10.1 和 10.2 可並行
- Task 12.1, 12.2, 12.3 可並行

---

## 總預估時間

- **階段 1**: 15 分鐘（0.25 小時）
- **階段 2**: 20 分鐘（0.33 小時）
- **階段 3**: 2.25 小時
- **階段 4**: 2.5 小時（新增 URL Slug 管理）
- **階段 5**: 2.5 小時
- **階段 6**: 1.25 小時
- **階段 7**: 1.25 小時
- **階段 8**: 2.33 小時（新增內部連結）
- **階段 9**: 1.58 小時
- **階段 10**: 1.25 小時
- **階段 11**: 0.83 小時
- **階段 12**: 5 小時（擴充測試範圍）
- **階段 13**: 2 小時

**總計**: 約 23.5 小時（3-4 個工作天）

**新增時間**（相比原計畫）:
- URL Slug 管理系統: +2.5 小時
- 內部連結自動化: +0.75 小時
- 擴充測試: +1.5 小時
- 擴充驗證: +0.75 小時

---

## 風險緩解

1. **Slug 唯一性**: 使用資料庫約束和應用層雙重保證，避免衝突
2. **排程準確性**: 使用系統時間戳記和 UTC，嚴格測試時區轉換
3. **並發控制**: 限制同時處理的任務數量，避免 API rate limit
4. **失敗恢復**: 實作完整的重試機制和錯誤追蹤
5. **網站對應**: 提供清晰的視覺回饋，允許使用者修正
6. **Token 成本**: 僅生成 1 個標題，預先檢查餘額
7. **URL 變更風險**: 使用 slug 而非完整 URL，便於未來變更網域
8. **內部連結失效**: 使用 slug 建立連結，確保平台無關性
