# 實作任務清單：Excel 自動化文章批次匯入系統

## 階段 1: 資料庫擴充

### Task 1.1: 新增 article_jobs 表欄位
- [ ] 建立資料庫 migration 檔案
- [ ] 新增 `article_type` 欄位（TEXT, CHECK constraint）
- [ ] 新增 `scheduled_publish_at` 欄位（TIMESTAMPTZ）
- [ ] 新增 `published_url` 欄位（TEXT）
- [ ] 執行 migration 並驗證
- **驗證**: 查詢表結構，確認新欄位存在
- **預估時間**: 15 分鐘

---

## 階段 2: 基礎設施準備

### Task 2.1: 安裝前端相依套件
- [ ] 安裝 `xlsx` 套件
- [ ] 更新 `package.json`
- [ ] 執行 `npm install`
- **驗證**: `npm list xlsx` 顯示已安裝版本
- **預估時間**: 5 分鐘

### Task 2.2: 建立檔案上傳頁面路由
- [ ] 建立 `/app/(dashboard)/dashboard/articles/import/page.tsx`
- [ ] 設定頁面 metadata 和權限
- [ ] 加入導航連結到側邊欄（「批次匯入」）
- **驗證**: 瀏覽器訪問 `/dashboard/articles/import` 正常顯示
- **預估時間**: 15 分鐘

---

## 階段 3: Excel 多欄位解析

### Task 3.1: 實作檔案上傳元件
- [ ] 建立 `@/components/articles/ExcelUploadZone.tsx`
- [ ] 實作拖放功能
- [ ] 實作檔案選擇按鈕
- [ ] 加入檔案格式和大小驗證
- **驗證**: 可上傳 Excel 檔案
- **預估時間**: 30 分鐘

### Task 3.2: 實作多欄位 Excel 解析
- [ ] 建立 `@/lib/utils/excel-parser.ts`
- [ ] 實作 `parseMultiColumnExcel` 函式
- [ ] 解析四欄：關鍵字、網站名稱、文章類型、發佈時間
- [ ] 自動識別標題列
- [ ] 支援欄位順序自動對應
- [ ] 驗證必填欄位（關鍵字、網站名稱）
- [ ] 過濾空白列
- [ ] 限制最多 500 個計畫
- **驗證**: 單元測試通過，解析範例 Excel 正確
- **預估時間**: 60 分鐘

### Task 3.3: 實作網站名稱智慧對應
- [ ] 建立 `@/lib/utils/website-matcher.ts`
- [ ] 實作精確匹配邏輯
- [ ] 實作模糊匹配邏輯（使用 Levenshtein distance）
- [ ] 回傳對應結果和建議
- **驗證**: 測試不同網站名稱的對應準確率
- **預估時間**: 45 分鐘

---

## 階段 4: 發佈計畫列表介面

### Task 4.1: 建立發佈計畫列表元件
- [ ] 建立 `@/components/articles/PublishPlanTable.tsx`
- [ ] 使用 Tanstack Table 顯示列表
- [ ] 定義欄位：序號、關鍵字、網站、類型、時間、狀態、網址
- [ ] 加入網站驗證狀態圖示（綠色勾選/黃色警告/紅色錯誤）
- **驗證**: 顯示完整的發佈計畫列表
- **預估時間**: 60 分鐘

### Task 4.2: 實作列表編輯功能
- [ ] 加入「編輯」按鈕和對話框
- [ ] 允許修改關鍵字、網站、類型、時間
- [ ] 加入單個和批次刪除功能
- [ ] 實作資料驗證
- **驗證**: 可編輯和刪除計畫項目
- **預估時間**: 45 分鐘

### Task 4.3: 實作排程設定介面
- [ ] 建立 `@/components/articles/ScheduleSettings.tsx`
- [ ] 提供固定間隔設定（輸入小時數）
- [ ] 顯示預覽：列出所有計畫的預計發佈時間
- [ ] 加入時間衝突檢測和警告
- **驗證**: 可設定間隔並預覽排程
- **預估時間**: 45 分鐘

---

## 階段 5: 自動標題生成

### Task 5.1: 實作自動標題生成 API
- [ ] 建立 `@/lib/services/auto-title-generator.ts`
- [ ] 實作單個標題生成函式（根據關鍵字和類型）
- [ ] 實作重試機制（最多 3 次）
- [ ] 失敗時回退到使用關鍵字作為標題
- **驗證**: 生成的標題符合品質標準
- **預估時間**: 45 分鐘

### Task 5.2: 實作批次標題生成邏輯
- [ ] 批次生成所有計畫的標題
- [ ] 並發控制（最多 5 個並發）
- [ ] 進度追蹤和回饋
- **驗證**: 可為 100 個計畫生成標題
- **預估時間**: 30 分鐘

---

## 階段 6: 文章類型智慧判斷

### Task 6.1: 建立文章類型判斷 API
- [ ] 建立 `/app/api/articles/determine-type/route.ts`
- [ ] 實作 AI 判斷邏輯（分析關鍵字）
- [ ] 支援四種類型：教學、排行榜、比較、資訊型
- [ ] 實作混合模式邏輯（Excel 優先）
- **驗證**: API 可正確判斷文章類型
- **預估時間**: 45 分鐘

### Task 6.2: 整合文章類型到生成策略
- [ ] 修改 `strategy-agent.ts`
- [ ] 根據 `article_type` 調整寫作策略
- [ ] 為每種類型定義專屬 prompt
- **驗證**: 不同類型生成不同風格的文章
- **預估時間**: 30 分鐘

---

## 階段 7: 批次任務建立 API

### Task 7.1: 建立批次匯入 API
- [ ] 建立 `/app/api/articles/import-batch/route.ts`
- [ ] 接收發佈計畫列表
- [ ] 處理網站名稱對應
- [ ] 生成所有標題
- [ ] 判斷文章類型（若未填）
- [ ] 計算排程時間（固定間隔或指定時間）
- [ ] 批次插入 `article_jobs`
- **驗證**: API 可批次建立任務
- **預估時間**: 60 分鐘

### Task 7.2: Token 餘額預檢
- [ ] 預估批次任務的總 token 消耗
- [ ] 檢查當前餘額
- [ ] 餘額不足時回傳錯誤
- **驗證**: 餘額不足時正確拒絕
- **預估時間**: 20 分鐘

---

## 階段 8: 排程系統實作

### Task 8.1: 建立排程處理器
- [ ] 建立 `@/lib/scheduler/article-scheduler.ts`
- [ ] 實作取得待處理任務邏輯（查詢 `scheduled_publish_at <= NOW()`）
- [ ] 實作任務觸發邏輯
- [ ] 實作並發控制（最多 5 個並發）
- **驗證**: 可正確取得和執行排程任務
- **預估時間**: 45 分鐘

### Task 8.2: 整合 GitHub Actions Cron
- [ ] 建立 `.github/workflows/process-scheduled-articles.yml`
- [ ] 設定 cron 排程（每 10 分鐘）
- [ ] 建立 API 端點 `/api/cron/process-scheduled-articles`
- [ ] 實作觸發邏輯
- **驗證**: Cron Job 定時執行
- **預估時間**: 30 分鐘

### Task 8.3: 時區處理
- [ ] 確保所有時間使用 UTC
- [ ] 前端顯示時轉換為本地時區
- [ ] 測試不同時區的排程準確性
- **驗證**: 排程時間準確無誤
- **預估時間**: 20 分鐘

---

## 階段 9: 發佈狀態追蹤

### Task 9.1: 實作即時狀態更新
- [ ] 修改文章生成 API，更新狀態為 `generating`
- [ ] 完成後更新為 `completed`
- [ ] 發佈時更新為 `publishing`
- [ ] 成功後更新為 `published` 並儲存網址
- [ ] 失敗時更新為 `failed` 並記錄錯誤
- **驗證**: 狀態正確追蹤
- **預估時間**: 30 分鐘

### Task 9.2: 前端即時更新
- [ ] 使用 Supabase Realtime 訂閱狀態變更
- [ ] 即時更新列表中的狀態欄位
- [ ] 顯示進度指示器
- **驗證**: 前端即時反映狀態變化
- **預估時間**: 30 分鐘

### Task 9.3: 發佈網址顯示
- [ ] WordPress 發佈成功後儲存網址到 `published_url`
- [ ] 列表中顯示可點擊的網址連結
- [ ] 加入「在新視窗開啟」功能
- **驗證**: 可點擊網址並開啟 WordPress 文章
- **預估時間**: 15 分鐘

---

## 階段 10: 錯誤處理與重試

### Task 10.1: 實作發佈重試機制
- [ ] 建立重試 API `/api/articles/jobs/[id]/retry`
- [ ] 檢查任務狀態為 `failed`
- [ ] 重新執行生成或發佈流程
- [ ] 更新狀態
- **驗證**: 可手動重試失敗任務
- **預估時間**: 30 分鐘

### Task 10.2: 實作錯誤訊息顯示
- [ ] 失敗時在列表中顯示錯誤圖示
- [ ] 點擊圖示顯示詳細錯誤訊息
- [ ] 提供重試按鈕
- **驗證**: 可查看錯誤詳情並重試
- **預估時間**: 20 分鐘

---

## 階段 11: 整合測試與優化

### Task 11.1: 端到端整合測試
- [ ] 測試完整流程：上傳 → 解析 → 排程 → 生成 → 發佈 → 網址顯示
- [ ] 測試不同 Excel 格式（完整欄位/部分欄位）
- [ ] 測試不同排程模式（指定時間/固定間隔/混合）
- [ ] 測試錯誤情況（網站不存在、餘額不足、發佈失敗）
- **驗證**: 所有情況正常運作
- **預估時間**: 90 分鐘

### Task 11.2: 效能優化
- [ ] 優化大量計畫解析速度
- [ ] 優化批次標題生成並發數
- [ ] 實作列表虛擬化（超過 100 個計畫）
- [ ] 加入請求快取
- **驗證**: 大量計畫處理流暢
- **預估時間**: 45 分鐘

### Task 11.3: 撰寫單元測試
- [ ] 測試 Excel 解析邏輯
- [ ] 測試網站名稱對應
- [ ] 測試標題生成
- [ ] 測試文章類型判斷
- [ ] 測試排程計算邏輯
- **驗證**: 所有測試通過
- **預估時間**: 60 分鐘

### Task 11.4: 建立範例 Excel 檔案
- [ ] 建立標準格式範例檔案
- [ ] 建立部分欄位範例檔案
- [ ] 提供下載連結
- [ ] 撰寫使用說明
- **驗證**: 使用者可下載並使用範例
- **預估時間**: 20 分鐘

---

## 階段 12: 部署與驗證

### Task 12.1: Lint 和 Typecheck
- [ ] 執行 `npm run lint` 並修復錯誤
- [ ] 執行 `npm run typecheck` 並修復類型錯誤
- [ ] 確認沒有使用 `any` 類型
- **驗證**: 無錯誤和警告
- **預估時間**: 30 分鐘

### Task 12.2: 建立功能分支並提交
- [ ] 建立分支 `feature/excel-auto-import`
- [ ] 提交所有更改（頻繁 commit）
- [ ] 推送到遠端
- **驗證**: 分支存在於遠端
- **預估時間**: 10 分鐘

### Task 12.3: 本地完整驗證
- [ ] 執行 `npm run build`
- [ ] 測試完整流程（上傳 → 排程 → 執行）
- [ ] 檢查資料庫記錄
- [ ] 檢查 WordPress 發佈結果
- **驗證**: 建置成功，功能完整
- **預估時間**: 30 分鐘

### Task 12.4: 部署到 Vercel 並驗證
- [ ] 部署到 Vercel
- [ ] 在生產環境測試功能
- [ ] 檢查 Vercel 日誌
- [ ] 驗證 GitHub Actions Cron Job 正常運作
- **驗證**: 生產環境功能正常
- **預估時間**: 30 分鐘

---

## 相依性與順序

**必須順序執行**:
- 階段 1 → 階段 2（資料庫擴充必須先完成）
- 階段 3 → 階段 4（解析後才能顯示列表）
- 階段 5, 6, 7 可並行（獨立功能）
- 階段 8 → 階段 9（排程後才能追蹤）
- 階段 11 → 階段 12（測試後才能部署）

**可並行執行**:
- Task 5.1 和 Task 6.1 可並行（獨立 API）
- Task 8.1 和 Task 8.2 可並行
- Task 9.1 和 Task 9.2 可並行
- Task 11.1, 11.2, 11.3 可並行

---

## 總預估時間

- **階段 1**: 15 分鐘
- **階段 2**: 20 分鐘
- **階段 3**: 2.25 小時
- **階段 4**: 2.5 小時
- **階段 5**: 1.25 小時
- **階段 6**: 1.25 小時
- **階段 7**: 1.33 小時
- **階段 8**: 1.58 小時
- **階段 9**: 1.25 小時
- **階段 10**: 0.83 小時
- **階段 11**: 3.58 小時
- **階段 12**: 1.67 小時

**總計**: 約 17.5 小時（2-3 個工作天）

---

## 風險緩解

1. **排程準確性**: 使用系統時間戳記和 UTC，嚴格測試時區轉換
2. **並發控制**: 限制同時處理的任務數量，避免 API rate limit
3. **失敗恢復**: 實作完整的重試機制和錯誤追蹤
4. **網站對應**: 提供清晰的視覺回饋，允許使用者修正
5. **Token 成本**: 僅生成 1 個標題，預先檢查餘額
