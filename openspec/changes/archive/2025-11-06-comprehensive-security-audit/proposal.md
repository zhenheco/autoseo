# 提案：全面安全審計與修復

## 摘要

針對整個代碼庫進行全面的安全審計,發現並修復多個關鍵安全漏洞,包括敏感資訊洩漏、XSS 漏洞、缺少認證機制等。

## 問題陳述

經過代碼審查,發現以下關鍵安全問題:

### 🚨 極高風險

**✅ 已確認**: .env.local 檔案已正確設定在 .gitignore 中,未被 git 追蹤,金鑰安全無虞。

1. **多個 console.log 可能洩漏敏感資訊**
   - `scripts/get-google-drive-token.ts:62`: 輸出 `GOOGLE_DRIVE_CLIENT_SECRET`
   - `scripts/test-env.ts`: 輸出 API_KEY 的部分內容
   - 需要建立安全的日誌過濾機制

### ⚠️ 高風險

4. **潛在的 XSS 漏洞**
   - `src/app/api/payment/callback/route.ts`: 在 HTML 中直接插入 `redirectUrl`,未經過適當的 escape
   - `dangerouslySetInnerHTML` 用於顯示文章內容,需要確保內容經過清理

5. **缺少 API 認證**
   - 需要審查所有 API routes 是否有適當的認證機制
   - 檢查是否有未受保護的敏感端點

6. **支付回調缺少簽章驗證強化**
   - 雖然有基本的解密和驗證,但需要加強防重放攻擊機制
   - 缺少請求來源 IP 白名單驗證

### 🔵 中風險

7. **環境變數管理不當**
   - `.gitignore` 有正確設定 `.env*`,但 `.env.local` 已經存在於專案中
   - 需要確認 `.env.local` 是否曾被提交到 git 歷史

8. **缺少安全標頭**
   - 需要檢查是否有設定適當的 HTTP 安全標頭
   - Content-Security-Policy, X-Frame-Options, etc.

## 目標

1. 建立安全的日誌系統,過濾敏感資訊
2. 修復潛在的 XSS 漏洞
3. 加強 API 認證機制
4. 實作完整的安全最佳實踐
5. 建立安全檢查清單和自動化工具
6. **確保所有修改不影響現有系統的穩定性和功能完整性**

## 影響範圍

- **安全性**: 極大影響,修復關鍵漏洞
- **功能**: 無影響,純粹安全強化
- **效能**: 輕微影響,增加驗證步驟
- **維護性**: 正面影響,建立安全規範

## 相關變更

- 無現有相關變更

## 風險評估

- **不實施的風險**: 極高 - 現有金鑰已洩漏,可能被濫用
- **實施的風險**: 低 - 主要是撤銷和替換金鑰,對現有功能無影響

## 替代方案

無 - 這是必須立即執行的安全修復

## 時間表

- **第一階段** (1-2 天): 建立日誌安全系統、修復 XSS
- **第二階段** (3-5 天): 加強認證、實作安全標頭
- **第三階段** (持續): 建立安全檢查自動化

## 成功標準

- [ ] 建立完整的日誌安全過濾系統
- [ ] 無任何 console.log 或日誌包含敏感資訊
- [ ] 所有 XSS 漏洞都已修復
- [ ] 所有 API endpoints 都有適當的認證
- [ ] 通過安全掃描工具驗證
- [ ] 建立安全檢查清單並整合到 CI/CD
- [ ] **所有現有功能保持正常運作,無任何破壞性變更**
