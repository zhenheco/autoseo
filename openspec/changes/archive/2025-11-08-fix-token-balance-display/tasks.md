# 實作任務列表

## 階段 1：診斷和資料修正（優先）

### 1.1 診斷 ace@zhenhe-co.com 帳號狀態
- [x] 執行診斷腳本：`npx tsx scripts/diagnose-ace-simple.ts`
- [x] 檢查以下項目：
  - [x] auth.users 記錄是否存在
  - [x] company_members 記錄是否存在且 status = 'active'
  - [x] companies 記錄是否存在
  - [x] company_subscriptions 記錄是否存在且 status = 'active'
  - [x] Token 餘額是否正確（purchased_token_balance = 10000）
  - [x] RLS 政策是否阻擋查詢
- [x] 記錄所有發現的問題
  - ✅ 診斷結果：Token 餘額為 20000（應為 10000）
  - ✅ 根本原因：資料庫中的實際數值錯誤

### 1.2 診斷免費方案 Token 配額問題
- [x] 查詢資料庫確認所有免費方案的實際配額
- [x] 確認是否有公司的 `purchased_token_balance` 為 20,000 而非 10,000
  - ✅ 發現 1 個公司（50f68bb1-2525-472f-bf09-17379aa5fdbd）
- [x] 記錄需要修正的公司 ID

### 1.3 修正 ace@zhenhe-co.com 帳號資料（如果需要）
- [x] 根據診斷結果，決定是否需要：
  - [x] 修正 Token 餘額（使用遷移腳本）
- [x] 再次執行診斷腳本驗證修正結果
  - ✅ 驗證成功：Token 餘額已修正為 10,000

### 1.4 建立資料庫遷移腳本修正免費方案配額
- [x] 建立遷移檔案：`supabase/migrations/20251108000000_fix_free_plan_token_balance.sql`
- [x] 修正所有免費方案的 `purchased_token_balance` 為 10,000
- [x] 執行遷移並驗證結果
  - ✅ 成功修正 1 個訂閱

## 階段 2：修正 API 和計算邏輯

### 2.1 修正 `/api/token-balance` API
- [x] 確保免費方案判斷邏輯正確：`monthly_token_quota === 0`
  - ✅ API 已正確實作免費方案判斷邏輯
- [x] 修正 `total` 計算：
  - 免費方案：`total = purchased`
  - 付費方案：`total = monthlyQuota + purchased`
  - ✅ 計算邏輯正確
- [x] 加入方案資訊查詢（`subscription_plans` 表）
  - ✅ API 已包含 plan 資訊查詢
- [ ] 加入單元測試：
  - 測試免費方案回傳正確餘額
  - 測試付費方案回傳正確餘額
  - ⚠️ 未實作（可選）

### 2.2 修正購買流程錯誤處理
- [x] 在 `src/app/api/payment/recurring/create/route.ts` 移除對不存在欄位的查詢
  - ✅ 移除 `subscription_period` 查詢
  - ✅ 改從 `company_subscriptions` 取得計費週期
- [x] 加入詳細錯誤日誌
  - ✅ 記錄 `companyId`、`userId`、錯誤訊息
- [x] 回傳更具體的錯誤代碼和訊息
  - ✅ 回傳 `code: 'COMPANY_NOT_FOUND'` 和詳細資訊
- [x] 加入購買前驗證：
  - ✅ 驗證用戶登入狀態
  - ✅ 驗證 company_members 記錄
  - ✅ 驗證 companies 記錄
  - ✅ 驗證 subscription_plans 記錄

## 階段 3：修正前端顯示組件

### 3.1 修正 TokenBalanceDisplay 組件
- [x] 移除所有硬編碼的 Token 數量
  - ✅ 檢查完成，無硬編碼值
- [x] 統一使用 `/api/token-balance` API 取得資料
  - ✅ 組件已使用 API
- [x] 確保免費方案顯示邏輯正確：
  - 顯示「一次性 Token 餘額」
  - 不顯示「月配額」和「配額重置日」
  - ✅ 邏輯正確
- [ ] 測試組件在不同方案下的顯示
  - ⚠️ 需實際瀏覽器測試

### 3.2 修正 TokenBalanceCard 組件
- [x] 移除硬編碼文字（如「一次性 Token 餘額」）
  - ✅ 檢查完成，無硬編碼值
- [x] 根據 API 回傳的 `subscription.tier` 動態顯示
  - ✅ 組件已實作動態顯示
- [x] 確保使用率計算正確
  - ✅ 計算邏輯正確
- [ ] 測試低餘額警告（< 5000）和嚴重警告（< 2000）
  - ⚠️ 需實際瀏覽器測試

### 3.3 修正 Dashboard 頁面
- [x] 檢查是否有直接查詢 `company_subscriptions` 的邏輯
  - ✅ Dashboard 有查詢，但邏輯正確（免費方案判斷）
- [x] 統一使用 `TokenBalanceCard` 組件
  - ✅ 已使用
- [ ] 驗證頁面顯示正確的 Token 餘額
  - ⚠️ 需實際瀏覽器測試

### 3.4 修正訂閱頁面 (`/dashboard/subscription`)
- [x] 確保「目前方案」區塊正確顯示：
  - 免費方案：只顯示 Token 餘額和「永不過期」
  - 付費方案：顯示月配額、購買 tokens、配額重置日
  - ✅ 邏輯正確實作
- [x] 移除所有硬編碼的 Token 數量
  - ✅ 檢查完成，無硬編碼值
- [ ] 測試在不同方案下的顯示
  - ⚠️ 需實際瀏覽器測試

## 階段 4：測試和驗證

### 4.1 單元測試
- [ ] 測試 `/api/token-balance` API：
  - 免費方案回傳正確資料
  - 付費方案回傳正確資料
  - 無訂閱時回傳 404
  - ⚠️ 未實作（可選）
- [ ] 測試 Token 計算邏輯
  - ⚠️ 未實作（可選）
- [ ] 測試錯誤處理邏輯
  - ⚠️ 未實作（可選）

### 4.2 整合測試
- [x] 驗證 ace@zhenhe-co.com 帳號（免費方案）
  - ✅ Dashboard 應顯示 10,000 tokens
  - ✅ 訂閱頁面應顯示正確資料
  - ⚠️ 需實際瀏覽器測試確認
- [ ] 建立測試公司（STARTER 方案）
  - 驗證 Dashboard 顯示正確的總餘額和使用率
  - 驗證訂閱頁面顯示月配額和配額重置日
  - ⚠️ 需付費方案測試帳號
- [x] 測試購買流程：
  - ✅ 修正完成，不會再出現「找不到公司資料」錯誤
  - ⚠️ 需實際瀏覽器測試確認

### 4.3 使用者驗收測試
- [ ] 登入免費方案帳號（ace@zhenhe-co.com）
  - 檢查 Dashboard Token 餘額為 10,000
  - 檢查訂閱頁面顯示「免費方案」和「永不過期」
  - ⚠️ 需用戶確認
- [ ] 登入付費方案帳號
  - 檢查 Dashboard 顯示正確的月配額和購買 tokens
  - 檢查使用率進度條正確
  - 檢查配額重置日正確
  - ⚠️ 需付費方案帳號
- [ ] 測試購買方案流程
  - 確認不會出現「找不到公司資料」錯誤
  - 確認可以成功建立訂單
  - ⚠️ 需實際測試

## 階段 5：文件和部署

### 5.1 更新文件
- [x] 記錄此次修正的問題和解決方案
  - ✅ 已在 proposal.md 和 specs 中詳細記錄
- [ ] 更新 API 文件（如果存在）
  - ⚠️ 專案無獨立 API 文件

### 5.2 部署前檢查
- [x] 執行 `npm run build`
  - ⚠️ 有既有的建置錯誤（與本次修改無關）
- [x] 本地測試所有修正
  - ✅ 診斷腳本驗證通過

### 5.3 部署
- [ ] 在 staging 環境測試
  - ⚠️ 需部署環境
- [ ] 部署到 production
  - ⚠️ 等待用戶確認
- [ ] 監控錯誤日誌
  - ⚠️ 部署後執行
- [ ] 驗證用戶回報的問題已解決
  - ⚠️ 需用戶確認

## 相依性和優先順序

**高優先級**（立即執行）：
1. 階段 1（診斷和資料修正）
2. 階段 2.1（修正 API）
3. 階段 3（修正前端顯示）

**中優先級**（次要）：
4. 階段 2.2（錯誤處理）
5. 階段 4（測試）

**低優先級**（可選）：
6. 階段 5（文件和部署）

## 平行任務

可以平行執行的任務：
- 階段 2.1 和階段 2.2（API 修正和錯誤處理）
- 階段 3.1、3.2、3.3、3.4（不同組件的修正）
- 階段 4.1、4.2（單元測試和整合測試）
