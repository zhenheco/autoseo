# å®Œå–„ä¿®å¾©è¨ˆåŠƒï¼ˆæ·±åº¦æ€è€ƒç‰ˆï¼‰

**æ—¥æœŸ**: 2025-01-16
**ç‰ˆæœ¬**: v2.0ï¼ˆå®Œå–„ç‰ˆï¼‰

---

## ğŸ” æ–°ç™¼ç¾çš„é—œéµå•é¡Œ

### 1. **Credits æ‰£é™¤å•é¡Œçš„æ ¹æœ¬åŸå› æœªæ‰¾åˆ°** âš ï¸

**ç¾æ³**ï¼š

- å·²ç”Ÿæˆ 5 ç¯‡æ–‡ç« ï¼ˆæ¯ç¯‡ ~2000 å­—ï¼‰
- token_usage_logs: 0 ç­†è¨˜éŒ„
- token_deduction_records: 0 ç­†è¨˜éŒ„
- é¤˜é¡æœªè®ŠåŒ–ï¼š50,000 tokens

**å•é¡Œ**ï¼š
æˆ‘å€‘çŸ¥é“ã€Œæ²’æœ‰æ‰£é™¤ã€ï¼Œä½†ä¸çŸ¥é“ã€Œç‚ºä»€éº¼æ²’æœ‰æ‰£é™¤ã€

**å¿…é ˆèª¿æŸ¥**ï¼š

1. æ–‡ç« ç”Ÿæˆçš„å¯¦éš›è·¯å¾‘ï¼ˆå¯èƒ½æœ‰å¤šæ¢ï¼‰
2. orchestrator.ts æ˜¯å¦çœŸçš„è¢«åŸ·è¡Œï¼Ÿ
3. GitHub Actions cron job ç‹€æ…‹
4. æ˜¯å¦æœ‰ç¹é token æ‰£é™¤çš„ç”Ÿæˆè·¯å¾‘ï¼Ÿ

**èª¿æŸ¥æª”æ¡ˆæ¸…å–®**ï¼š

- `/api/articles/generate/route.ts` - ç”Ÿæˆ API å…¥å£
- `/api/articles/jobs/**` - Job è™•ç†é‚è¼¯
- `/.github/workflows/**` - GitHub Actions é…ç½®
- `/lib/agents/orchestrator.ts` - Token æ‰£é™¤é‚è¼¯
- `/lib/billing/token-billing-service.ts` - è¨ˆè²»æœå‹™

---

### 2. **è³‡æ–™ä¸€è‡´æ€§å’Œäº‹å‹™è™•ç†** âš ï¸

**ç™¼ç¾çš„é¢¨éšª**ï¼š

#### A. WordPress ç™¼ä½ˆçš„åŸå­æ€§

```typescript
// âŒ å±éšªï¼šå¯èƒ½å°è‡´ä¸ä¸€è‡´
await fetch(wordpress_api); // æˆåŠŸ
await supabase.update(); // å¤±æ•— â†’ WordPress æœ‰æ–‡ç« ä½†è³‡æ–™åº«ç„¡è¨˜éŒ„

// âœ… æ‡‰è©²ï¼šäº‹å‹™è™•ç†æˆ–è£œå„Ÿæ©Ÿåˆ¶
try {
  const wpResult = await publishToWordPress();
  await updateDatabase(wpResult);
} catch (error) {
  await rollbackWordPress(wpResult.postId); // è£œå„Ÿé‚è¼¯
  throw error;
}
```

#### B. Token æ‰£é™¤çš„åŸå­æ€§

```typescript
// âŒ å±éšªï¼šå¯èƒ½é‡è¤‡æ‰£é™¤æˆ–éºæ¼
await saveArticle();
await deductTokens(); // å¦‚æœé€™è£¡å¤±æ•—ï¼Ÿ

// âœ… æ‡‰è©²ï¼šä½¿ç”¨è³‡æ–™åº«äº‹å‹™
await supabase.rpc("atomic_article_creation", {
  article_data,
  token_amount,
});
```

#### C. å†ªç­‰æ€§ä¿è­·

```typescript
// âœ… å·²æœ‰ idempotency keyï¼Œä½†éœ€ç¢ºä¿ï¼š
// 1. æ¯æ¬¡è«‹æ±‚ä½¿ç”¨ç›¸åŒçš„ key
// 2. é˜²æ­¢ç”¨æˆ¶é‡è¤‡é»æ“Šç™¼ä½ˆ
// 3. API ç´šåˆ¥çš„é˜²é‡è¤‡æ©Ÿåˆ¶
```

---

### 3. **ç‹€æ…‹ç®¡ç†çš„è¤‡é›œæ€§** âš ï¸

**å•é¡Œ**ï¼š
æ–‡ç« æœ‰å…©å€‹ç‹€æ…‹æ¬„ä½ï¼š`status` å’Œ `wordpress_status`

**ç•¶å‰é‚è¼¯æ··äº‚**ï¼š

- `status`: generated, published, scheduled, processing, pending, failed
- `wordpress_status`: generated, draft, publish

**éœ€è¦é‡æ¸…çš„è¦å‰‡**ï¼š

1. ä»€éº¼æ™‚å€™é¡¯ç¤º `status`ï¼Ÿ
2. ä»€éº¼æ™‚å€™é¡¯ç¤º `wordpress_status`ï¼Ÿ
3. å…©è€…è¡çªæ™‚çš„å„ªå…ˆé †åºï¼Ÿ
4. ç‹€æ…‹è½‰æ›çš„å®Œæ•´ç‹€æ…‹æ©Ÿï¼Ÿ

**å»ºè­°çš„é¡¯ç¤ºé‚è¼¯**ï¼š

```typescript
function getDisplayStatus(article) {
  // å„ªå…ˆé¡¯ç¤º WordPress ç‹€æ…‹
  if (article.wordpress_post_id) {
    return {
      type: "wordpress",
      status: article.wordpress_status,
      icon: getWordPressIcon(article.wordpress_status),
      color: getWordPressColor(article.wordpress_status),
    };
  }

  // å¦å‰‡é¡¯ç¤ºæ–‡ç« ç”Ÿæˆç‹€æ…‹
  return {
    type: "generation",
    status: article.status,
    icon: getGenerationIcon(article.status),
    color: getGenerationColor(article.status),
  };
}
```

---

## ğŸ“‹ å®Œå–„å¾Œçš„ä¿®å¾©è¨ˆåŠƒ

### éšæ®µ 0ï¼šæ·±å…¥è¨ºæ–·ï¼ˆæ–°å¢ï¼‰âš ï¸ P0

#### 0.1 èª¿æŸ¥ Credits æ‰£é™¤å•é¡Œæ ¹æœ¬åŸå› 

**ç›®æ¨™**ï¼šæ‰¾å‡ºç‚ºä»€éº¼ token æ²’æœ‰è¢«æ‰£é™¤

**æ­¥é©Ÿ**ï¼š

1. è¿½è¹¤æ–‡ç« ç”Ÿæˆçš„å®Œæ•´æµç¨‹

   ```bash
   # æª¢æŸ¥ç”Ÿæˆ API
   grep -r "generate.*article" src/app/api/

   # æª¢æŸ¥ job è™•ç†
   grep -r "article.*job" src/app/api/

   # æª¢æŸ¥ orchestrator èª¿ç”¨
   grep -r "orchestrator" src/
   ```

2. æª¢æŸ¥ GitHub Actions workflows

   ```bash
   ls -la .github/workflows/
   cat .github/workflows/*.yml
   ```

3. æª¢æŸ¥æ–‡ç« è¨˜éŒ„çš„ metadata

   ```sql
   SELECT id, article_job_id, created_at,
          article_metadata
   FROM generated_articles
   ORDER BY created_at DESC
   LIMIT 3;
   ```

4. æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ç”Ÿæˆè·¯å¾‘
   - ç›´æ¥ç”Ÿæˆï¼ˆåŒæ­¥ï¼‰
   - Job éšŠåˆ—ï¼ˆç•°æ­¥ï¼‰
   - Cron jobï¼ˆå®šæ™‚ï¼‰
   - Webhookï¼ˆè§¸ç™¼ï¼‰

**è¼¸å‡º**ï¼š

- æ–‡ç« ç”Ÿæˆæµç¨‹åœ–
- Token æ‰£é™¤å¤±æ•—çš„å…·é«”åŸå› 
- ä¿®å¾©æ–¹æ¡ˆ

---

### éšæ®µ 1ï¼šè¨ºæ–·ï¼ˆå·²å®Œæˆï¼‰âœ…

#### 1.1 è³‡æ–™åº«è¨ºæ–· âœ…

- [x] æª¢æŸ¥è¡¨çµæ§‹
- [x] æª¢æŸ¥ç•¶å‰æ•¸æ“š
- [x] ç¢ºèªæ¬„ä½å­˜åœ¨

#### 1.2 WordPress API æ¸¬è©¦ âœ…

- [x] REST API å¯è¨ªå•æ€§
- [x] Application Password èªè­‰
- [x] å»ºç«‹æ¸¬è©¦æ–‡ç« 

#### 1.3 å‰ç«¯ç‹€æ…‹æª¢æŸ¥ âœ…

- [x] ç¨‹å¼ç¢¼åˆ†æ
- [x] æ¨£å¼å•é¡Œç¢ºèª
- [x] ç‹€æ…‹é¡¯ç¤ºé‚è¼¯æª¢æŸ¥

---

### éšæ®µ 2ï¼šä¿®å¾©ï¼ˆå„ªå…ˆé †åºèª¿æ•´ï¼‰

#### 2.0 æ·±å…¥è¨ºæ–· Credits æ‰£é™¤ï¼ˆæ–°å¢ï¼‰âš ï¸ P0

**é‡è¦æ€§**ï¼šå¿…é ˆå…ˆæ‰¾åˆ°æ ¹æœ¬åŸå› å†ä¿®å¾©

**ä»»å‹™**ï¼š

1. èª¿æŸ¥æ–‡ç« ç”Ÿæˆæµç¨‹
2. æª¢æŸ¥ orchestrator åŸ·è¡Œç‹€æ³
3. é©—è­‰ GitHub Actions
4. æ‰¾å‡º token æ‰£é™¤å¤±æ•—çš„ç¢ºåˆ‡åŸå› 

**é è¨ˆæ™‚é–“**ï¼š30 åˆ†é˜

---

#### 2.1 ä¿®å¾© WordPress ç™¼ä½ˆåŠŸèƒ½ âš ï¸ P0

**å®Œå–„å…§å®¹**ï¼š

**2.1.1 å¯¦ä½œ WordPress API å‘¼å«**

```typescript
// src/app/api/articles/[id]/publish/route.ts

import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } },
) {
  const supabase = await createClient();
  const { website_id, publish_status } = await request.json();

  try {
    // 1. ç²å–æ–‡ç« å…§å®¹
    const { data: article, error: articleError } = await supabase
      .from("generated_articles")
      .select("*")
      .eq("id", params.id)
      .single();

    if (articleError) throw articleError;

    // 2. ç²å– WordPress é…ç½®
    const { data: website, error: websiteError } = await supabase
      .from("website_configs")
      .select("*")
      .eq("id", website_id)
      .single();

    if (websiteError) throw websiteError;

    // 3. é©—è­‰ WordPress å•Ÿç”¨
    if (!website.wp_enabled) {
      return NextResponse.json(
        { error: "WordPress åŠŸèƒ½æœªå•Ÿç”¨" },
        { status: 400 },
      );
    }

    // 4. å»ºç«‹ WordPress API client
    const wpAuth = Buffer.from(
      `${website.wp_username}:${website.wp_app_password}`,
    ).toString("base64");

    // 5. ç™¼ä½ˆåˆ° WordPress
    const wpResponse = await fetch(
      `${website.wordpress_url}/wp-json/wp/v2/posts`,
      {
        method: "POST",
        headers: {
          Authorization: `Basic ${wpAuth}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          title: article.title,
          content: article.html_content,
          status: publish_status, // 'publish' or 'draft'
          excerpt: article.excerpt || "",
          categories: article.categories || [],
          tags: article.tags || [],
        }),
      },
    );

    if (!wpResponse.ok) {
      const error = await wpResponse.json();
      throw new Error(
        `WordPress API error: ${error.message || wpResponse.statusText}`,
      );
    }

    const wpPost = await wpResponse.json();

    // 6. æ›´æ–°è³‡æ–™åº«ï¼ˆä½¿ç”¨äº‹å‹™ï¼‰
    const { error: updateError } = await supabase
      .from("generated_articles")
      .update({
        wordpress_post_id: wpPost.id,
        wordpress_post_url: wpPost.link,
        wordpress_status: publish_status,
        status: "published",
        published_at: new Date().toISOString(),
        published_to_website_id: website_id,
        published_to_website_at: new Date().toISOString(),
      })
      .eq("id", params.id);

    if (updateError) {
      // å˜—è©¦åˆªé™¤å·²å»ºç«‹çš„ WordPress æ–‡ç« ï¼ˆè£œå„Ÿé‚è¼¯ï¼‰
      try {
        await fetch(
          `${website.wordpress_url}/wp-json/wp/v2/posts/${wpPost.id}`,
          {
            method: "DELETE",
            headers: { Authorization: `Basic ${wpAuth}` },
          },
        );
      } catch (rollbackError) {
        console.error("Failed to rollback WordPress post:", rollbackError);
      }

      throw updateError;
    }

    return NextResponse.json({
      success: true,
      wordpress_post_id: wpPost.id,
      wordpress_post_url: wpPost.link,
    });
  } catch (error) {
    console.error("Publish error:", error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Unknown error" },
      { status: 500 },
    );
  }
}
```

**2.1.2 é˜²æ­¢é‡è¤‡ç™¼ä½ˆ**

```typescript
// åœ¨ç™¼ä½ˆå‰æª¢æŸ¥
if (article.wordpress_post_id) {
  return NextResponse.json(
    { error: "æ–‡ç« å·²ç™¼ä½ˆåˆ° WordPress" },
    { status: 400 },
  );
}
```

**2.1.3 å‰ç«¯é˜²é‡è¤‡é»æ“Š**

```typescript
// ä½¿ç”¨ loading ç‹€æ…‹
const [isPublishing, setIsPublishing] = useState(false);

const handlePublish = async () => {
  if (isPublishing) return;

  setIsPublishing(true);
  try {
    await publishArticle();
  } finally {
    setIsPublishing(false);
  }
};
```

**é è¨ˆæ™‚é–“**ï¼š40 åˆ†é˜

---

#### 2.1.1 æ–°å¢ç¶²ç«™æ™‚é©—è­‰ WordPress é€£ç·š âš ï¸ P0

**å®Œå–„å…§å®¹**ï¼š

**A. å»ºç«‹é©—è­‰ API**

```typescript
// src/app/api/websites/verify/route.ts

export async function POST(request: NextRequest) {
  const { wordpress_url, wp_username, wp_app_password } = await request.json();

  try {
    // 1. é©—è­‰ REST API å¯è¨ªå•æ€§
    const apiCheckResponse = await fetch(`${wordpress_url}/wp-json/wp/v2`, {
      method: "HEAD",
    });

    if (!apiCheckResponse.ok) {
      return NextResponse.json({
        success: false,
        error: "WordPress REST API ç„¡æ³•è¨ªå•",
        details: `HTTP ${apiCheckResponse.status}`,
      });
    }

    // 2. é©—è­‰èªè­‰
    const wpAuth = Buffer.from(`${wp_username}:${wp_app_password}`).toString(
      "base64",
    );

    const authCheckResponse = await fetch(
      `${wordpress_url}/wp-json/wp/v2/users/me`,
      {
        headers: { Authorization: `Basic ${wpAuth}` },
      },
    );

    if (!authCheckResponse.ok) {
      const error = await authCheckResponse.json();
      return NextResponse.json({
        success: false,
        error: "èªè­‰å¤±æ•—",
        details: error.message || "ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤",
      });
    }

    const userData = await authCheckResponse.json();

    // 3. æ¸¬è©¦ç™¼ä½ˆæ¬Šé™
    const testPostResponse = await fetch(
      `${wordpress_url}/wp-json/wp/v2/posts`,
      {
        method: "POST",
        headers: {
          Authorization: `Basic ${wpAuth}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          title: "[æ¸¬è©¦] é€£ç·šé©—è­‰",
          content: "æ­¤ç‚ºè‡ªå‹•åŒ–æ¸¬è©¦æ–‡ç« ï¼Œå¯å®‰å…¨åˆªé™¤ã€‚",
          status: "draft",
        }),
      },
    );

    if (!testPostResponse.ok) {
      return NextResponse.json({
        success: false,
        error: "ç„¡ç™¼ä½ˆæ¬Šé™",
        details: "å¸³è™Ÿæ²’æœ‰å»ºç«‹æ–‡ç« çš„æ¬Šé™",
      });
    }

    const testPost = await testPostResponse.json();

    // 4. åˆªé™¤æ¸¬è©¦æ–‡ç« 
    await fetch(
      `${wordpress_url}/wp-json/wp/v2/posts/${testPost.id}?force=true`,
      {
        method: "DELETE",
        headers: { Authorization: `Basic ${wpAuth}` },
      },
    );

    return NextResponse.json({
      success: true,
      user: {
        id: userData.id,
        name: userData.name,
        email: userData.email,
      },
    });
  } catch (error) {
    return NextResponse.json({
      success: false,
      error: "é€£ç·šå¤±æ•—",
      details: error instanceof Error ? error.message : "Unknown error",
    });
  }
}
```

**B. å‰ç«¯é©—è­‰ UI**

```typescript
// æ–°å¢/ç·¨è¼¯ç¶²ç«™å°è©±æ¡†

const [verifying, setVerifying] = useState(false);
const [verifyResult, setVerifyResult] = useState(null);

const handleVerify = async () => {
  setVerifying(true);
  setVerifyResult(null);

  try {
    const response = await fetch("/api/websites/verify", {
      method: "POST",
      body: JSON.stringify({
        wordpress_url,
        wp_username,
        wp_app_password,
      }),
    });

    const result = await response.json();
    setVerifyResult(result);

    if (result.success) {
      toast.success("é€£ç·šé©—è­‰æˆåŠŸ");
    } else {
      toast.error(result.error, {
        description: result.details,
      });
    }
  } catch (error) {
    toast.error("é©—è­‰å¤±æ•—");
  } finally {
    setVerifying(false);
  }
};

const handleSave = async () => {
  // å„²å­˜å‰äºŒæ¬¡é©—è­‰
  if (!verifyResult?.success) {
    toast.error("è«‹å…ˆé©—è­‰ WordPress é€£ç·š");
    return;
  }

  // ç¹¼çºŒå„²å­˜...
};
```

**é è¨ˆæ™‚é–“**ï¼š30 åˆ†é˜

---

#### 2.2 ä¿®å¾©æ–‡ç« ç‹€æ…‹é¡¯ç¤ºé‚è¼¯ âš ï¸ P1

**å®Œå–„å…§å®¹**ï¼š

**A. æ›´æ–° ArticleStatusIcon çµ„ä»¶**

```typescript
// src/components/articles/ArticleStatusIcon.tsx

interface ArticleStatusIconProps {
  status: string;
  wordpressStatus?: string | null;
  wordpressPostId?: number | null;
  publishedToWebsiteName?: string | null;
  publishedAt?: string | null;
  scheduledAt?: string | null;
}

export function ArticleStatusIcon({
  status,
  wordpressStatus,
  wordpressPostId,
  publishedToWebsiteName,
  publishedAt,
  scheduledAt,
}: ArticleStatusIconProps) {
  const getStatusConfig = () => {
    // å„ªå…ˆé¡¯ç¤º WordPress ç‹€æ…‹
    if (wordpressPostId && wordpressStatus) {
      switch (wordpressStatus) {
        case "publish":
          return {
            icon: CheckCircle,
            label: `å·²ç™¼ä½ˆåˆ° ${publishedToWebsiteName}`,
            description: publishedAt
              ? `ç™¼ä½ˆæ™‚é–“: ${new Date(publishedAt).toLocaleString("zh-TW")}`
              : "",
            iconClassName: "text-red-600 dark:text-red-400", // ç´…è‰²åœ“åœˆ
          };
        case "draft":
          return {
            icon: FileEdit,
            label: `è‰ç¨¿ï¼ˆ${publishedToWebsiteName}ï¼‰`,
            iconClassName: "text-yellow-600 dark:text-yellow-400",
          };
        default:
          return {
            icon: Clock,
            label: wordpressStatus,
            iconClassName: "text-gray-600 dark:text-gray-400",
          };
      }
    }

    // å¦å‰‡é¡¯ç¤ºæ–‡ç« ç”Ÿæˆç‹€æ…‹
    switch (status) {
      case "completed":
      case "generated":
        return {
          icon: Check,
          label: "å·²å®Œæˆ",
          iconClassName: "text-green-600 dark:text-green-400",
        };
      // ... å…¶ä»–ç‹€æ…‹
    }
  };

  // ... å…¶é¤˜é‚è¼¯
}
```

**B. æ›´æ–°æ–‡ç« åˆ—è¡¨å‚³é props**

```typescript
<ArticleStatusIcon
  status={item.status}
  wordpressStatus={item.article?.wordpress_status}
  wordpressPostId={item.article?.wordpress_post_id}
  publishedToWebsiteName={item.article?.published_to_website_name}
  publishedAt={item.article?.published_at}
  scheduledAt={item.article?.scheduled_at}
/>
```

**é è¨ˆæ™‚é–“**ï¼š20 åˆ†é˜

---

#### 2.3 ä¿®å¾© Credits æ‰£é™¤æ©Ÿåˆ¶ âš ï¸ P0

**ä¾è³´**ï¼šå¿…é ˆå…ˆå®Œæˆéšæ®µ 2.0 è¨ºæ–·

**å¯èƒ½çš„ä¿®å¾©æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šå¦‚æœ orchestrator æœªè¢«èª¿ç”¨**

- ä¿®æ”¹æ–‡ç« ç”Ÿæˆ APIï¼Œç¢ºä¿èª¿ç”¨ orchestrator
- åŠ å…¥å¼·åˆ¶ token æª¢æŸ¥

**æ–¹æ¡ˆ Bï¼šå¦‚æœ token æ‰£é™¤é‚è¼¯æœ‰ bug**

- ä¿®å¾© TokenBillingService
- ç¢ºä¿äº‹å‹™å®Œæ•´æ€§

**æ–¹æ¡ˆ Cï¼šå¦‚æœ idempotency key å¤±æ•ˆ**

- ä¿®æ­£ key ç”Ÿæˆé‚è¼¯
- ç¢ºä¿æ¯æ¬¡ä½¿ç”¨æ­£ç¢ºçš„ key

**é è¨ˆæ™‚é–“**ï¼šä¾è¨ºæ–·çµæœè€Œå®šï¼ˆ30-60 åˆ†é˜ï¼‰

---

#### 2.4 å„ªåŒ–æ–‡ç« åˆ—è¡¨æ¨£å¼ ğŸ¨ P2

**ä¿®æ”¹æª”æ¡ˆ**ï¼š`src/app/(dashboard)/dashboard/articles/page.tsx`

```typescript
// è¡Œ 265ï¼šæ¨™é¡Œè®Šå¤§
<h3 className="text-base font-semibold truncate">  // æ”¹ç‚º text-base (16px)

// è¡Œ 271ï¼šMeta è³‡æ–™ä¿æŒæˆ–ç•¥å¤§
<div className="flex gap-3 text-xs text-muted-foreground mt-1">  // æ”¹ç‚º text-xs (12px)

// æ–°å¢ï¼šç™¼ä½ˆè³‡è¨Š
{item.wordpress_post_url && (
  <span className="text-green-600">
    å·²ç™¼ä½ˆåˆ° {item.published_to_website_name}
  </span>
)}
```

**é è¨ˆæ™‚é–“**ï¼š10 åˆ†é˜

---

#### 2.5 åŠ å…¥è©³ç´°æ—¥èªŒè¿½è¹¤ï¼ˆæ–°å¢ï¼‰âš ï¸ P1

**ç›®æ¨™**ï¼šç¢ºä¿æ‰€æœ‰é—œéµæ“ä½œéƒ½æœ‰æ—¥èªŒ

**å¯¦ä½œä½ç½®**ï¼š

**A. WordPress ç™¼ä½ˆæ—¥èªŒ**

```typescript
// åœ¨ç™¼ä½ˆ API ä¸­
console.log("[Publish] Starting publish to WordPress", {
  articleId: params.id,
  websiteId: website_id,
  publishStatus: publish_status,
});

console.log("[Publish] WordPress API response", {
  postId: wpPost.id,
  postUrl: wpPost.link,
});

console.log("[Publish] Database updated successfully");
```

**B. Token æ‰£é™¤æ—¥èªŒ**

```typescript
// åœ¨ orchestrator ä¸­
console.log("[Token] Starting token deduction", {
  articleJobId: input.articleJobId,
  companyId: input.companyId,
  amount: totalTokenUsage.charged,
});

console.log("[Token] Token deducted successfully", {
  balanceBefore,
  balanceAfter,
});
```

**C. éŒ¯èª¤æ—¥èªŒ**

```typescript
// çµ±ä¸€éŒ¯èª¤æ ¼å¼
console.error("[Error] Operation failed", {
  operation: "publish",
  articleId,
  error: error.message,
  stack: error.stack,
});
```

**é è¨ˆæ™‚é–“**ï¼š15 åˆ†é˜

---

### éšæ®µ 3ï¼šå®Œæ•´æ¸¬è©¦é©—è­‰ï¼ˆå®Œå–„ï¼‰

#### 3.1 æ•´åˆæ¸¬è©¦ï¼ˆæ–°å¢ï¼‰

**ç›®æ¨™**ï¼šæ¨¡æ“¬çœŸå¯¦ç”¨æˆ¶æ“ä½œ

**æ¸¬è©¦æµç¨‹**ï¼š

1. å»ºç«‹æ–°æ–‡ç«  â†’ æª¢æŸ¥ token æ‰£é™¤
2. ç™¼ä½ˆåˆ° WordPress â†’ é©—è­‰ post ID
3. æª¢æŸ¥ç‹€æ…‹é¡¯ç¤º â†’ ç¢ºèªç´…è‰²åœ“åœˆ
4. æª¢æŸ¥è³‡æ–™åº«ä¸€è‡´æ€§

#### 3.2 éŒ¯èª¤è™•ç†æ¸¬è©¦ï¼ˆæ–°å¢ï¼‰

- WordPress API å¤±æ•—
- Token ä¸è¶³
- ç¶²è·¯éŒ¯èª¤
- ä¸¦ç™¼è«‹æ±‚

#### 3.3 å‰ç«¯æ¸¬è©¦ï¼ˆä½¿ç”¨ chrome-devtools MCPï¼‰

- Console éŒ¯èª¤æª¢æŸ¥
- Network è«‹æ±‚é©—è­‰
- UI æ¸²æŸ“æª¢æŸ¥

**é è¨ˆæ™‚é–“**ï¼š30 åˆ†é˜

---

### éšæ®µ 4ï¼šç›£æ§æ©Ÿåˆ¶å»ºç«‹ï¼ˆå®Œå–„ï¼‰

#### 4.1 Token ä½¿ç”¨å„€è¡¨æ¿ï¼ˆæ–°å¢ï¼‰

- å³æ™‚é¤˜é¡é¡¯ç¤º
- ä½¿ç”¨è¶¨å‹¢åœ–è¡¨
- ç•°å¸¸è­¦å ±

#### 4.2 WordPress ç™¼ä½ˆç›£æ§ï¼ˆæ–°å¢ï¼‰

- æˆåŠŸç‡çµ±è¨ˆ
- å¤±æ•—åŸå› åˆ†é¡
- ç™¼ä½ˆæ™‚é–“åˆ†æ

#### 4.3 å¥åº·æª¢æŸ¥è…³æœ¬ï¼ˆæ–°å¢ï¼‰

```bash
#!/bin/bash
# scripts/health-check.sh

echo "=== ç³»çµ±å¥åº·æª¢æŸ¥ ==="

# 1. WordPress é€£ç·š
echo "æª¢æŸ¥ WordPress é€£ç·š..."
curl -s -I https://zhenhe-co.com/wp-json/wp/v2

# 2. è³‡æ–™åº«é€£ç·š
echo "æª¢æŸ¥è³‡æ–™åº«é€£ç·š..."
psql "$SUPABASE_DB_URL" -c "SELECT 1"

# 3. Token é¤˜é¡
echo "æª¢æŸ¥ token é¤˜é¡..."
psql "$SUPABASE_DB_URL" -c "
  SELECT monthly_quota_balance, purchased_token_balance
  FROM company_subscriptions
  WHERE status = 'active'
"

# 4. æœ€è¿‘éŒ¯èª¤
echo "æª¢æŸ¥æœ€è¿‘éŒ¯èª¤..."
# å¦‚æœæœ‰éŒ¯èª¤æ—¥èªŒè¡¨
```

**é è¨ˆæ™‚é–“**ï¼š20 åˆ†é˜

---

## ğŸ“Š ä¿®å¾©æ™‚é–“ä¼°è¨ˆ

| éšæ®µ     | ä»»å‹™                  | é è¨ˆæ™‚é–“       | å„ªå…ˆç´š |
| -------- | --------------------- | -------------- | ------ |
| 2.0      | æ·±å…¥è¨ºæ–· Credits æ‰£é™¤ | 30 åˆ†é˜        | P0     |
| 2.1      | WordPress ç™¼ä½ˆåŠŸèƒ½    | 40 åˆ†é˜        | P0     |
| 2.1.1    | æ–°å¢ç¶²ç«™é©—è­‰          | 30 åˆ†é˜        | P0     |
| 2.2      | æ–‡ç« ç‹€æ…‹é¡¯ç¤º          | 20 åˆ†é˜        | P1     |
| 2.3      | Credits æ‰£é™¤ä¿®å¾©      | 30-60 åˆ†é˜     | P0     |
| 2.4      | UI æ¨£å¼å„ªåŒ–           | 10 åˆ†é˜        | P2     |
| 2.5      | æ—¥èªŒè¿½è¹¤              | 15 åˆ†é˜        | P1     |
| 3        | å®Œæ•´æ¸¬è©¦              | 30 åˆ†é˜        | -      |
| 4        | ç›£æ§æ©Ÿåˆ¶              | 20 åˆ†é˜        | -      |
| **ç¸½è¨ˆ** |                       | **3.5-4 å°æ™‚** |        |

---

## âœ… é©—è­‰æ¨™æº–ï¼ˆå®Œå–„ç‰ˆï¼‰

### åŠŸèƒ½é©—è­‰

- [ ] WordPress ç™¼ä½ˆæˆåŠŸï¼ˆåœ¨ WordPress ç¶²ç«™ä¸Šå¯è¦‹ï¼‰
- [ ] è³‡æ–™åº«æœ‰æ­£ç¢ºçš„ post ID å’Œ URL
- [ ] å·²ç™¼ä½ˆæ–‡ç« é¡¯ç¤ºç´…è‰²åœ“åœˆç‹€æ…‹
- [ ] Credits åœ¨æ–‡ç« ç”Ÿæˆå¾Œæ­£ç¢ºæ‰£é™¤
- [ ] Token ä½¿ç”¨è¨˜éŒ„å®Œæ•´ï¼ˆåŒ…å«æ‰€æœ‰æ­¥é©Ÿï¼‰
- [ ] æ–°å¢ç¶²ç«™æ™‚é©—è­‰åŠŸèƒ½æ­£å¸¸
- [ ] éŒ¯èª¤æ™‚æœ‰æ­£ç¢ºçš„å›æ»¾æ©Ÿåˆ¶

### è³‡æ–™ä¸€è‡´æ€§

- [ ] wordpress_post_id å’Œ wordpress_post_url åŒæ™‚å­˜åœ¨æˆ–åŒæ™‚ç‚º NULL
- [ ] status å’Œ wordpress_status é‚è¼¯ä¸€è‡´
- [ ] Token æ‰£é™¤è¨˜éŒ„èˆ‡é¤˜é¡è®ŠåŒ–ä¸€è‡´
- [ ] æ²’æœ‰å­¤ç«‹çš„ WordPress æ–‡ç« ï¼ˆè³‡æ–™åº«ç„¡è¨˜éŒ„ï¼‰

### å‰ç«¯é©—è­‰

- [ ] æ–‡ç« æ¨™é¡Œå­—é«”æ¯” meta è³‡æ–™å¤§
- [ ] ç„¡å‰ç«¯ Console éŒ¯èª¤
- [ ] Network è«‹æ±‚å…¨éƒ¨æˆåŠŸ
- [ ] ç‹€æ…‹åœ–ç¤ºæ­£ç¢ºé¡¯ç¤º

### æŠ€è¡“é©—è­‰

- [ ] `pnpm run build` æˆåŠŸé€šé
- [ ] `pnpm run typecheck` ç„¡éŒ¯èª¤
- [ ] æ‰€æœ‰ psql æŸ¥è©¢è¿”å›é æœŸçµæœ
- [ ] curl æ¸¬è©¦å…¨éƒ¨é€šé

### æ•ˆèƒ½é©—è­‰

- [ ] ç™¼ä½ˆæ“ä½œ < 5 ç§’
- [ ] æ–‡ç« åˆ—è¡¨è¼‰å…¥ < 2 ç§’
- [ ] ç„¡è³‡æ–™åº«æ­»é–æˆ–è¶…æ™‚

---

## ğŸ”§ é¢¨éšªæ§åˆ¶

### é«˜é¢¨éšªæ“ä½œ

1. **ä¿®æ”¹ Token æ‰£é™¤é‚è¼¯**
   - é¢¨éšªï¼šå¯èƒ½å½±éŸ¿ç¾æœ‰è¨ˆè²»
   - ç·©è§£ï¼šå…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰

2. **WordPress ç™¼ä½ˆå›æ»¾**
   - é¢¨éšªï¼šå¯èƒ½åˆªé™¤ç”¨æˆ¶å·²ç·¨è¼¯çš„æ–‡ç« 
   - ç·©è§£ï¼šåŠ å…¥ç¢ºèªæ©Ÿåˆ¶

3. **è³‡æ–™åº«äº‹å‹™**
   - é¢¨éšªï¼šå¯èƒ½é€ æˆæ­»é–
   - ç·©è§£ï¼šä½¿ç”¨é©ç•¶çš„éš”é›¢ç´šåˆ¥

### å›æ»¾è¨ˆåŠƒ

- æ¯å€‹ä¿®å¾©å‰å»ºç«‹ git åˆ†æ”¯
- ä¿ç•™åŸæœ‰ç¨‹å¼ç¢¼è¨»è§£
- è³‡æ–™åº«è®Šæ›´æœ‰ migration è…³æœ¬

---

**è¨ˆåŠƒå®Œæˆæ™‚é–“**ï¼š2025-01-16
**ä¸‹ä¸€æ­¥**ï¼šç­‰å¾…ç”¨æˆ¶ç¢ºèªå¾Œé–‹å§‹åŸ·è¡Œ
