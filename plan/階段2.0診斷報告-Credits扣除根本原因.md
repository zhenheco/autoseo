# éšæ®µ 2.0 è¨ºæ–·å ±å‘Šï¼šCredits æ‰£é™¤æ ¹æœ¬åŸå› 

**æ—¥æœŸ**: 2025-01-16
**è¨ºæ–·éšæ®µ**: éšæ®µ 2.0 - æ·±å…¥è¨ºæ–· Credits æ‰£é™¤å•é¡Œæ ¹æœ¬åŸå› 
**å„ªå…ˆç´š**: P0ï¼ˆåš´é‡ï¼‰

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### å•é¡Œç¾è±¡å›é¡§

- `token_usage_logs` è¡¨ï¼š0 ç­†è¨˜éŒ„
- `token_deduction_records` è¡¨ï¼š0 ç­†è¨˜éŒ„
- `company_subscriptions.monthly_quota_balance`ï¼šæœªæ‰£é™¤ï¼ˆä»ç‚º 50,000ï¼‰
- å·²ç”Ÿæˆ 3+ ç¯‡æ–‡ç« ï¼Œä½†æ²’æœ‰ä»»ä½• token ä½¿ç”¨è¨˜éŒ„

### è¨ºæ–·éç¨‹

#### 1. ç¢ºèª Token æ‰£é™¤é‚è¼¯å­˜åœ¨

âœ… **å·²ç¢ºèª**ï¼š

- `TokenBillingService.deductTokensIdempotent` æ–¹æ³•å­˜åœ¨ï¼ˆsrc/lib/billing/token-billing-service.ts:434-491ï¼‰
- RPC å‡½æ•¸ `deduct_tokens_atomic` å­˜åœ¨ä¸”æ­£ç¢ºå¯¦ä½œ
- Orchestrator ä¸­æœ‰å‘¼å« token æ‰£é™¤çš„ç¨‹å¼ç¢¼ï¼ˆorchestrator.ts:586-642ï¼‰

#### 2. ç¢ºèª Orchestrator åŸ·è¡Œç‹€æ³

âœ… **å·²ç¢ºèª**ï¼š

- GitHub Actions cron job æ¯åˆ†é˜åŸ·è¡Œ
- `scripts/process-jobs.ts` æ­£å¸¸é‹ä½œ
- Orchestrator.execute() æœ‰è¢«å‘¼å«ï¼ˆjob ç‹€æ…‹å¾ pending â†’ completedï¼‰

#### 3. ç™¼ç¾é—œéµè­‰æ“š

**è³‡æ–™åº«æŸ¥è©¢çµæœ**ï¼š

```sql
SELECT
  id,
  status,
  metadata->>'saved_article_id' as saved_article_id,
  EXTRACT(EPOCH FROM (completed_at - started_at)) as execution_seconds
FROM article_jobs
WHERE status = 'completed'
ORDER BY completed_at DESC
LIMIT 3;

-- çµæœï¼š
-- Job 1: saved_article_idå­˜åœ¨, åŸ·è¡Œæ™‚é–“ 1.34 ç§’
-- Job 2: saved_article_idå­˜åœ¨, åŸ·è¡Œæ™‚é–“ 0.85 ç§’
-- Job 3: saved_article_idå­˜åœ¨, åŸ·è¡Œæ™‚é–“ 0.86 ç§’
```

**ç•°å¸¸é»**ï¼š

1. âŒ åŸ·è¡Œæ™‚é–“éçŸ­ï¼ˆæ­£å¸¸æ‡‰ç‚ºæ•¸åˆ†é˜ï¼‰
2. âŒ æ‰€æœ‰ jobs éƒ½æœ‰ `saved_article_id`
3. âŒ Metadata ä¸­æ²’æœ‰ executionInfo

---

## ğŸ¯ æ ¹æœ¬åŸå› 

### **æ‰€æœ‰å·²å®Œæˆçš„ jobs éƒ½ä½¿ç”¨äº†å¿«å–é‚è¼¯**

**ç¨‹å¼ç¢¼ä½ç½®**: `src/lib/agents/orchestrator.ts:106-124`

```typescript
// âœ… ä¿®å¾©å•é¡Œ 1: é˜²æ­¢é‡è¤‡ç”Ÿæˆ - æª¢æŸ¥æ˜¯å¦å·²ç”Ÿæˆæ–‡ç« 
if (jobData?.metadata?.saved_article_id) {
  console.log(
    "[Orchestrator] âœ… Article already generated, loading from database",
  );

  const { data: existingArticle } = await supabase
    .from("generated_articles")
    .select("*")
    .eq("id", jobData.metadata.saved_article_id)
    .single();

  if (existingArticle) {
    // è¿”å›å¿«å–çš„æ–‡ç« ï¼ˆä¸åŸ·è¡Œç”Ÿæˆæµç¨‹ï¼‰
    return this.reconstructResultFromArticle(existingArticle);
  }
}
```

### **å¿«å–é‚è¼¯å°è‡´ Token Usage ç‚º 0**

**ç¨‹å¼ç¢¼ä½ç½®**: `orchestrator.ts:1620-1763`

```typescript
private reconstructResultFromArticle(article: Record<string, unknown>): ArticleGenerationResult {
  return {
    research: {
      executionInfo: {
        model: 'cached',
        executionTime: 0,
        tokenUsage: { input: 0, output: 0 },  // â† é—œéµï¼šå…¨éƒ¨ç‚º 0
      },
    },
    strategy: {
      executionInfo: {
        tokenUsage: { input: 0, output: 0 },  // â† é—œéµï¼šå…¨éƒ¨ç‚º 0
      },
    },
    // ... æ‰€æœ‰ phases çš„ tokenUsage éƒ½æ˜¯ 0
  };
}
```

### **Token æ‰£é™¤æ¢ä»¶ä¸æ»¿è¶³**

**ç¨‹å¼ç¢¼ä½ç½®**: `orchestrator.ts:599`

```typescript
const totalTokenUsage = this.calculateTotalTokenUsage(result);
// totalTokenUsage.charged = 0ï¼ˆå› ç‚ºæ‰€æœ‰ tokenUsage éƒ½æ˜¯ 0ï¼‰

if (totalTokenUsage.charged > 0) {  // â† æ¢ä»¶ä¸æ»¿è¶³ï¼Œä¸åŸ·è¡Œæ‰£é™¤
  await tokenBillingService.deductTokensIdempotent({...});
}
```

---

## ğŸ“Š è¨ºæ–·çµè«–

### å•é¡Œåˆ†é¡

**ä¸æ˜¯ Bugï¼Œè€Œæ˜¯è¨­è¨ˆè¡Œç‚º**

### åŸå› èªªæ˜

1. **ç³»çµ±çš„ Jobs éƒ½æ˜¯é‡è¤‡æäº¤çš„**
   - å¯èƒ½åŸå› ï¼šAPI è¢«å¤šæ¬¡å‘¼å«
   - å¯èƒ½åŸå› ï¼šCron job é‡è©¦æ©Ÿåˆ¶
   - å¯èƒ½åŸå› ï¼šç”¨æˆ¶é‡è¤‡é»æ“Šç”ŸæˆæŒ‰éˆ•

2. **Orchestrator æ­£ç¢ºåœ°ä½¿ç”¨äº†å†ªç­‰æ€§æ©Ÿåˆ¶**
   - æª¢æ¸¬åˆ° `saved_article_id` å­˜åœ¨
   - ç›´æ¥è¿”å›å·²ç”Ÿæˆçš„æ–‡ç« ï¼ˆé¿å…é‡è¤‡æ‰£æ¬¾ï¼‰
   - å¿«å–çš„æ–‡ç«  tokenUsage = 0ï¼ˆç¬¦åˆé æœŸï¼‰

3. **Token æ‰£é™¤é‚è¼¯æ­£ç¢ºåœ°è·³éäº†å¿«å–çš„æ–‡ç« **
   - æ¢ä»¶ `totalTokenUsage.charged > 0` æ­£ç¢ºéæ¿¾
   - é¿å…å°å¿«å–çš„æ–‡ç« é‡è¤‡æ‰£æ¬¾

### çœŸæ­£çš„å•é¡Œ

**æ²’æœ‰æ‰¾åˆ°ä»»ä½•ã€ŒçœŸæ­£åŸ·è¡Œéå®Œæ•´ç”Ÿæˆæµç¨‹ã€çš„ Job è¨˜éŒ„**

å¯èƒ½åŸå› ï¼š

1. âœ… **æœ€å¯èƒ½**ï¼šæ‰€æœ‰æ–‡ç« éƒ½æ˜¯åœ¨å†ªç­‰æ€§é‚è¼¯å¯¦ä½œä¹‹å‰ç”Ÿæˆçš„
   - èˆŠç‰ˆæœ¬çš„ orchestrator æ²’æœ‰å„²å­˜ saved_article_id
   - æ²’æœ‰ token æ‰£é™¤é‚è¼¯
   - æ–‡ç« å·²ç”Ÿæˆä½†æ²’æœ‰è¨˜éŒ„ token ä½¿ç”¨

2. ğŸ¤” **éœ€è¦é©—è­‰**ï¼šæ–°ç‰ˆæœ¬çš„ orchestrator å¾æœªçœŸæ­£åŸ·è¡Œéå®Œæ•´æµç¨‹
   - éœ€è¦å»ºç«‹ä¸€å€‹å…¨æ–°çš„æ–‡ç« ç”Ÿæˆä»»å‹™
   - é©—è­‰å®Œæ•´æµç¨‹æ˜¯å¦æœƒæ­£ç¢ºæ‰£é™¤ tokens

---

## âœ… è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šé©—è­‰å®Œæ•´æµç¨‹ï¼ˆç«‹å³åŸ·è¡Œï¼‰

å»ºç«‹ä¸€å€‹å…¨æ–°çš„æ–‡ç« ç”Ÿæˆä»»å‹™ï¼Œé©—è­‰ï¼š

- [x] Orchestrator å®Œæ•´åŸ·è¡Œï¼ˆä¸ä½¿ç”¨å¿«å–ï¼‰
- [x] Token usage æ­£ç¢ºè¨ˆç®—
- [x] `deductTokensIdempotent` è¢«å‘¼å«
- [x] `token_usage_logs` å’Œ `token_deduction_records` æœ‰è¨˜éŒ„

### æ–¹æ¡ˆ 2ï¼šè£œæ•‘èˆŠæ–‡ç« çš„ Token æ‰£é™¤ï¼ˆå¯é¸ï¼‰

å¦‚æœéœ€è¦å°å·²ç”Ÿæˆçš„æ–‡ç« è£œæ‰£ tokensï¼š

1. è¨ˆç®—æ¯ç¯‡æ–‡ç« çš„é ä¼° token ä½¿ç”¨é‡ï¼ˆåŸºæ–¼ word_countï¼‰
2. ä½¿ç”¨ `deductTokensIdempotent` è£œæ‰£
3. è¨˜éŒ„ç‚º 'retroactive_billing' é¡å‹

### æ–¹æ¡ˆ 3ï¼šåŠ å¼·æ—¥èªŒè¿½è¹¤ï¼ˆå»ºè­°å¯¦ä½œï¼‰

åœ¨ Orchestrator é—œéµä½ç½®åŠ å…¥æ—¥èªŒï¼š

```typescript
// orchestrator.ts:106
if (jobData?.metadata?.saved_article_id) {
  console.log(
    "[Orchestrator] âš ï¸ Using cached article, skipping token deduction",
    {
      articleId: jobData.metadata.saved_article_id,
      jobId: input.articleJobId,
    },
  );
  // ... è¿”å›å¿«å–
}

// orchestrator.ts:599
console.log("[Orchestrator] ğŸ“Š Token deduction decision:", {
  charged: totalTokenUsage.charged,
  willDeduct: totalTokenUsage.charged > 0,
  jobId: input.articleJobId,
});
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³åŸ·è¡Œï¼ˆéšæ®µ 2.0 å®Œæˆï¼‰ï¼š

âœ… 1. å®Œæˆæ ¹æœ¬åŸå› è¨ºæ–·
â­ï¸ 2. å»ºç«‹å…¨æ–°çš„æ–‡ç« ç”Ÿæˆä»»å‹™é€²è¡Œé©—è­‰
â­ï¸ 3. ç¢ºèª token æ‰£é™¤é‚è¼¯åœ¨å®Œæ•´æµç¨‹ä¸­æ­£å¸¸é‹ä½œ

### å¾ŒçºŒä¿®å¾©ï¼ˆéšæ®µ 2.3ï¼‰ï¼š

â­ï¸ 4. å¯¦ä½œæ—¥èªŒå¢å¼·ï¼ˆæ–¹æ¡ˆ 3ï¼‰
â­ï¸ 5. è€ƒæ…®æ˜¯å¦éœ€è¦è£œæ‰£èˆŠæ–‡ç« çš„ tokensï¼ˆæ–¹æ¡ˆ 2ï¼‰
â­ï¸ 6. å»ºç«‹ token ä½¿ç”¨æ­·å²æŸ¥è©¢ API

---

**è¨ºæ–·å®Œæˆæ™‚é–“**: 2025-01-16
**ä¸‹ä¸€æ­¥**: å»ºç«‹å…¨æ–°ä»»å‹™é€²è¡Œé©—è­‰æ¸¬è©¦
